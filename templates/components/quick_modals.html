{# 快捷操作模态框组件 - 连接后端 API #}

{# 车辆入场模态框 #}
<div id="entry-modal" 
     class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 backdrop-enter"
     role="dialog"
     aria-modal="true"
     aria-labelledby="entry-modal-title"
     aria-describedby="entry-modal-description">
  <div class="card-theme rounded-2xl w-full max-w-md transform transition-all modal-enter">
    <div class="p-6 border-b border-theme">
      <div class="flex items-center justify-between">
        <h3 id="entry-modal-title" class="text-xl font-bold text-theme-primary flex items-center gap-2">
          <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-xl flex items-center justify-center" aria-hidden="true">
            <i class="fas fa-sign-in-alt text-emerald-500"></i>
          </div>
          车辆入场
        </h3>
        <button type="button"
                onclick="closeModal('entry-modal')" 
                class="p-2 text-theme-muted hover:text-theme-primary hover:bg-theme-hover rounded-lg transition-all hover:scale-110 active:scale-95 group"
                aria-label="关闭车辆入场对话框">
          <i class="fas fa-times group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>
        </button>
      </div>
      <p id="entry-modal-description" class="text-sm text-theme-muted mt-2 hidden">填写车辆信息完成入场登记</p>
    </div>
    
    <form id="entry-form" class="p-6 space-y-4" novalidate>
      {% csrf_token %}
      <div>
        <label for="entry-plate" class="block text-sm font-medium text-theme-secondary mb-2">车牌号码</label>
        <div class="relative space-y-2">
          <input type="hidden" 
                 id="entry-plate" 
                 name="license_plate" 
                 required 
                 data-plate-field="true" 
                 class="input-focus-enhanced"
                 aria-describedby="entry-plate-hint entry-plate-error"
                 aria-invalid="false"
                 aria-required="true">
          <div class="plate-grid" data-plate-grid-for="entry-plate" aria-label="车牌号输入"></div>
          <span id="entry-plate-status" class="absolute right-3 top-1/2 -translate-y-1/2 hidden animate-fade-in" aria-hidden="true">
            <i class="fas fa-check-circle text-emerald-500"></i>
          </span>
        </div>
        <p id="entry-plate-hint" class="text-xs text-theme-muted mt-1">支持普通车牌（7位）和新能源车牌（8位）</p>
        <p id="entry-plate-error" class="text-red-500 text-sm mt-1 hidden animate-slide-up" role="alert" aria-live="polite"></p>
      </div>
      
      <div>
        <label for="entry-lot" class="block text-sm font-medium text-theme-secondary mb-2">选择停车场</label>
        <select id="entry-lot" 
                name="parking_lot" 
                required
                class="input-theme input-focus-enhanced w-full px-4 py-3 rounded-xl transition-all cursor-pointer"
                onchange="loadAvailableSpaces(this.value)"
                aria-describedby="entry-lot-hint"
                aria-required="true">
          <option value="">请选择停车场</option>
          {% for lot in parking_lots %}
            {% if lot.available_spaces > 0 %}
              <option value="{{ lot.id }}">{{ lot.name }} (剩余{{ lot.available_spaces }}位)</option>
            {% endif %}
          {% endfor %}
        </select>
        <p id="entry-lot-hint" class="text-xs text-theme-muted mt-1">选择车辆要停放的停车场</p>
      </div>
      
      <div id="entry-space-field" class="hidden animate-slide-up">
        <label class="block text-sm font-medium text-theme-secondary mb-2">
          选择停车位 <span class="text-red-500">*</span>
        </label>
        <select id="entry-space" name="parking_space_id"
                class="input-theme input-focus-enhanced w-full px-4 py-3 rounded-xl transition-all cursor-pointer"
                required>
          <option value="">请选择停车位（必选）</option>
        </select>
        <p class="text-theme-muted text-xs mt-1 flex items-center gap-1">
          <i class="fas fa-info-circle"></i>
          请选择车辆实际停放的停车位，确保记录准确
        </p>
      </div>
      
      <div>
        <fieldset>
          <legend class="block text-sm font-medium text-theme-secondary mb-2">车辆类型</legend>
          <div class="grid grid-cols-4 gap-2" role="radiogroup" aria-labelledby="vehicle-type-label">
            <label class="relative cursor-pointer">
              <input type="radio" 
                     name="vehicle_type" 
                     value="car" 
                     class="peer sr-only" 
                     checked
                     aria-describedby="vehicle-type-hint">
              <div class="p-3 border border-theme rounded-xl text-center transition-all
                          peer-checked:border-primary-500 peer-checked:bg-primary-50 dark:peer-checked:bg-primary-900/20
                          hover:bg-theme-hover">
                <i class="fas fa-car text-xl text-blue-500" aria-hidden="true"></i>
                <p class="text-xs text-theme-muted mt-1">轿车</p>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" 
                     name="vehicle_type" 
                     value="suv" 
                     class="peer sr-only"
                     aria-describedby="vehicle-type-hint">
              <div class="p-3 border border-theme rounded-xl text-center transition-all
                          peer-checked:border-primary-500 peer-checked:bg-primary-50 dark:peer-checked:bg-primary-900/20
                          hover:bg-theme-hover">
                <i class="fas fa-truck-pickup text-xl text-emerald-500" aria-hidden="true"></i>
                <p class="text-xs text-theme-muted mt-1">SUV</p>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" 
                     name="vehicle_type" 
                     value="motorcycle" 
                     class="peer sr-only"
                     aria-describedby="vehicle-type-hint">
              <div class="p-3 border border-theme rounded-xl text-center transition-all
                          peer-checked:border-primary-500 peer-checked:bg-primary-50 dark:peer-checked:bg-primary-900/20
                          hover:bg-theme-hover">
                <i class="fas fa-motorcycle text-xl text-amber-500" aria-hidden="true"></i>
                <p class="text-xs text-theme-muted mt-1">摩托</p>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" 
                     name="vehicle_type" 
                     value="truck" 
                     class="peer sr-only"
                     aria-describedby="vehicle-type-hint">
              <div class="p-3 border border-theme rounded-xl text-center transition-all
                          peer-checked:border-primary-500 peer-checked:bg-primary-50 dark:peer-checked:bg-primary-900/20
                          hover:bg-theme-hover">
                <i class="fas fa-truck text-xl text-red-500" aria-hidden="true"></i>
                <p class="text-xs text-theme-muted mt-1">货车</p>
              </div>
            </label>
          </div>
          <p id="vehicle-type-hint" class="text-xs text-theme-muted mt-1">选择车辆类型以确定收费标准</p>
        </fieldset>
      </div>
      
      <div class="pt-4 flex gap-3">
          <button type="button" 
                  onclick="closeModal('entry-modal')"
                  class="btn-interactive flex-1 px-4 py-3 border border-theme text-theme-secondary rounded-xl hover:bg-theme-hover font-medium transition-all group"
                  aria-label="取消车辆入场">
          <i class="fas fa-times mr-2 group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>取消
        </button>
        <button type="submit" 
                id="entry-submit-btn"
                class="btn-interactive ripple-effect flex-1 px-4 py-3 btn-primary rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-all group"
                aria-label="确认车辆入场">
          <i class="fas fa-check mr-2 group-hover:scale-110 transition-transform duration-200" aria-hidden="true"></i>确认入场
        </button>
      </div>
    </form>
  </div>
</div>

{# 车辆出场模态框 #}
<div id="exit-modal" 
     class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 backdrop-enter"
     role="dialog"
     aria-modal="true"
     aria-labelledby="exit-modal-title"
     aria-describedby="exit-modal-description">
  <div class="card-theme rounded-2xl w-full max-w-md transform transition-all modal-enter">
    <div class="p-6 border-b border-theme">
      <div class="flex items-center justify-between">
        <h3 id="exit-modal-title" class="text-xl font-bold text-theme-primary flex items-center gap-2">
          <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center" aria-hidden="true">
            <i class="fas fa-sign-out-alt text-blue-500"></i>
          </div>
          车辆出场
        </h3>
        <button type="button"
                onclick="closeModal('exit-modal')" 
                class="p-2 text-theme-muted hover:text-theme-primary hover:bg-theme-hover rounded-lg transition-all hover:scale-110 active:scale-95 group"
                aria-label="关闭车辆出场对话框">
          <i class="fas fa-times group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>
        </button>
      </div>
      <p id="exit-modal-description" class="text-sm text-theme-muted mt-2 hidden">输入车牌号查询并完成出场登记</p>
    </div>
    
    <div class="p-6 space-y-4">
      <div>
        <label for="exit-plate" class="block text-sm font-medium text-theme-secondary mb-2">车牌号码</label>
        <div class="relative">
          <input type="hidden" id="exit-plate" data-plate-field="true">
          <div class="plate-grid" data-plate-grid-for="exit-plate"></div>
          <button type="button" onclick="searchForExit()" id="exit-search-btn"
                  class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-all hover:scale-110 active:scale-95 group">
            <i class="fas fa-search group-hover:rotate-90 transition-transform duration-300"></i>
          </button>
        </div>
      </div>
      
      {# 加载中 #}
      <div id="exit-loading" class="hidden text-center py-8">
        <i class="fas fa-spinner fa-spin text-4xl text-primary-500 mb-3"></i>
        <p class="text-theme-muted">正在查询...</p>
      </div>
      
      {# 查询结果区域 #}
      <div id="exit-result" 
           class="hidden"
           role="region"
           aria-labelledby="exit-result-title"
           aria-live="polite">
        <h4 id="exit-result-title" class="sr-only">车辆出场信息</h4>
        <div class="p-4 bg-theme-secondary rounded-xl space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-theme-muted">车牌号</span>
            <span id="exit-result-plate" class="font-mono font-bold text-theme-primary" aria-live="polite">-</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-theme-muted">停车场</span>
            <span id="exit-result-lot" class="text-theme-secondary" aria-live="polite">-</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-theme-muted">车位号</span>
            <span id="exit-result-space" class="text-theme-secondary" aria-live="polite">-</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-theme-muted">入场时间</span>
            <span id="exit-result-entry" class="text-theme-secondary" aria-live="polite">-</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-theme-muted">停车时长</span>
            <span id="exit-result-duration" class="text-theme-secondary" aria-live="polite">-</span>
          </div>
          <div class="border-t border-theme pt-3 flex items-center justify-between">
            <span class="text-lg font-medium text-theme-primary">应付费用</span>
            <span id="exit-result-fee" class="text-2xl font-bold text-amber-500" aria-live="polite">¥0.00</span>
          </div>
        </div>
        <input type="hidden" id="exit-record-id" value="">
        
        <div class="pt-4 flex gap-3">
          <button type="button" 
                  onclick="closeModal('exit-modal')"
                  class="btn-interactive flex-1 px-4 py-3 border border-theme text-theme-secondary rounded-xl hover:bg-theme-hover font-medium transition-all group"
                  aria-label="取消车辆出场">
            <i class="fas fa-times mr-2 group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>取消
          </button>
          <button type="button" 
                  onclick="confirmExit()" 
                  id="exit-confirm-btn"
                  class="btn-interactive ripple-effect flex-1 px-4 py-3 btn-primary rounded-xl font-medium transition-all group"
                  aria-label="确认结算并出场">
            <i class="fas fa-credit-card mr-2 group-hover:scale-110 transition-transform duration-200" aria-hidden="true"></i>确认结算
          </button>
        </div>
      </div>
      
      {# 未找到提示 #}
      <div id="exit-not-found" 
           class="hidden text-center py-8"
           role="alert"
           aria-live="polite">
        <div class="w-16 h-16 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center mx-auto mb-3" aria-hidden="true">
          <i class="fas fa-exclamation-triangle text-2xl text-amber-500"></i>
        </div>
        <p class="text-theme-secondary" id="exit-error-msg">未找到该车辆的停车记录</p>
        <p class="text-theme-muted text-sm mt-1">请确认车牌号是否正确</p>
      </div>
    </div>
  </div>
</div>

{# 车辆查询模态框 #}
<div id="search-modal" 
     class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 backdrop-enter"
     role="dialog"
     aria-modal="true"
     aria-labelledby="search-modal-title"
     aria-describedby="search-modal-description">
  <div class="card-theme rounded-2xl w-full max-w-lg transform transition-all modal-enter">
    <div class="p-6 border-b border-theme">
      <div class="flex items-center justify-between">
        <h3 id="search-modal-title" class="text-xl font-bold text-theme-primary flex items-center gap-2">
          <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center" aria-hidden="true">
            <i class="fas fa-search text-purple-500"></i>
          </div>
          车辆查询
        </h3>
        <button type="button"
                onclick="closeModal('search-modal')" 
                class="p-2 text-theme-muted hover:text-theme-primary hover:bg-theme-hover rounded-lg transition-all hover:scale-110 active:scale-95 group"
                aria-label="关闭车辆查询对话框">
          <i class="fas fa-times group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>
        </button>
      </div>
      <p id="search-modal-description" class="text-sm text-theme-muted mt-2 hidden">输入车牌号查询车辆停车信息</p>
    </div>
    
    <div class="p-6 space-y-4">
      <div>
        <label for="search-plate" class="block text-sm font-medium text-theme-secondary mb-2">车牌号码</label>
        <div class="relative">
          <input type="hidden" 
                 id="search-plate" 
                 name="license_plate"
                 data-plate-field="true"
                 aria-describedby="search-plate-hint"
                 aria-required="true">
          <div class="plate-grid" data-plate-grid-for="search-plate" aria-label="车牌号输入"></div>
          <button type="button" 
                  onclick="searchVehicle()" 
                  id="search-btn"
                  class="btn-interactive absolute right-2 top-1/2 -translate-y-1/2 p-2 text-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-all group"
                  aria-label="查询车辆信息">
            <i class="fas fa-search group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>
          </button>
        </div>
        <p id="search-plate-hint" class="text-xs text-theme-muted mt-1">输入车牌号查询停车记录</p>
      </div>
      
      {# 加载中 #}
      <div id="search-loading" 
           class="hidden text-center py-8"
           role="status"
           aria-live="polite"
           aria-label="正在查询车辆信息">
        <i class="fas fa-spinner fa-spin text-4xl text-primary-500 mb-3" aria-hidden="true"></i>
        <p class="text-theme-muted">正在查询...</p>
      </div>
      
      {# 查询结果列表 #}
      <div id="search-results" 
           class="max-h-80 overflow-y-auto space-y-2"
           role="region"
           aria-labelledby="search-results-title"
           aria-live="polite">
        <h4 id="search-results-title" class="sr-only">查询结果</h4>
        <div class="text-center py-8 text-theme-muted" aria-live="polite">
          <i class="fas fa-search text-4xl opacity-30 mb-3" aria-hidden="true"></i>
          <p>输入车牌号进行查询</p>
        </div>
      </div>
    </div>
  </div>
</div>

{# 操作成功提示模态框 #}
<div id="success-modal" class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 backdrop-enter">
  <div class="card-theme rounded-2xl w-full max-w-sm text-center p-8 transform transition-all modal-enter">
    <div class="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
      <i class="fas fa-check text-3xl text-emerald-500"></i>
    </div>
    <h3 class="text-xl font-bold text-theme-primary mb-2" id="success-title">操作成功</h3>
    <p class="text-theme-muted mb-6" id="success-message">-</p>
    <button onclick="closeModal('success-modal')"
            class="btn-interactive ripple-effect w-full px-4 py-3 btn-primary rounded-xl font-medium transition-all">
      确定
    </button>
  </div>
</div>

{# 操作错误提示模态框 #}
<div id="error-modal" class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 backdrop-enter">
  <div class="card-theme rounded-2xl w-full max-w-sm text-center p-8 transform transition-all modal-enter">
    <div class="w-20 h-20 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
      <i class="fas fa-times text-3xl text-red-500"></i>
    </div>
    <h3 class="text-xl font-bold text-theme-primary mb-2" id="error-title">操作失败</h3>
    <p class="text-theme-muted mb-6" id="error-message">-</p>
    <button onclick="closeModal('error-modal');"
            class="btn-interactive ripple-effect w-full px-4 py-3 btn-primary rounded-xl font-medium transition-all">
      确定
    </button>
  </div>
</div>

{# 模态框脚本 - 连接后端 API #}
<script>
  // CSRF Token
  const csrfToken = '{{ csrf_token }}';
  
  // API 请求封装
  async function apiRequest(url, method = 'GET', data = null) {
    const options = {
      method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
    };
    
    if (data && method !== 'GET') {
      options.body = JSON.stringify(data);
    }
    
    const response = await fetch(url, options);
    return await response.json();
  }
  
  // 显示成功提示
  function showSuccess(title, message) {
    document.getElementById('success-title').textContent = title;
    document.getElementById('success-message').textContent = message;
    document.getElementById('success-modal').classList.remove('hidden');
  }
  
  // 显示错误提示
  function showError(title, message) {
    document.getElementById('error-title').textContent = title;
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-modal').classList.remove('hidden');
  }
  
  // 车牌号实时验证
  let plateValidateTimer = null;
  document.getElementById('entry-plate').addEventListener('input', function(e) {
    const plate = e.target.value.toUpperCase();
    e.target.value = plate;
    
    clearTimeout(plateValidateTimer);
    
    const statusEl = document.getElementById('entry-plate-status');
    const errorEl = document.getElementById('entry-plate-error');
    
    if (plate.length >= 7) {
      plateValidateTimer = setTimeout(async () => {
        const result = await apiRequest(`/parking/api/validate-plate/?license_plate=${encodeURIComponent(plate)}`);
        
        if (result.success) {
          statusEl.innerHTML = '<i class="fas fa-check-circle text-emerald-500"></i>';
          statusEl.classList.remove('hidden');
          errorEl.classList.add('hidden');
        } else {
          statusEl.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
          statusEl.classList.remove('hidden');
          errorEl.textContent = result.message;
          errorEl.classList.remove('hidden');
        }
      }, 300);
    } else {
      statusEl.classList.add('hidden');
      errorEl.classList.add('hidden');
    }
  });
  
  // 加载可用停车位
  async function loadAvailableSpaces(lotId) {
    const spaceField = document.getElementById('entry-space-field');
    const spaceSelect = document.getElementById('entry-space');
    
    if (!lotId) {
      spaceField.classList.add('hidden');
      spaceSelect.innerHTML = '<option value="">请选择停车位（必选）</option>';
      return;
    }
    
    // 显示加载状态
    spaceSelect.disabled = true;
    spaceSelect.innerHTML = '<option value="">加载中...</option>';
    spaceField.classList.remove('hidden');
    
    try {
      const result = await apiRequest(`/parking/api/available-spaces/?parking_lot_id=${lotId}`);
      
      if (result.success && result.data.spaces.length > 0) {
        spaceSelect.innerHTML = '<option value="">请选择停车位（必选）</option>';
        result.data.spaces.forEach(space => {
          const option = document.createElement('option');
          option.value = space.id;
          const typeMap = {
            'standard': '标准',
            'vip': 'VIP',
            'large': '大型',
            'disabled': '残疾人'
          };
          option.textContent = `${space.space_number} (${typeMap[space.space_type] || space.space_type})`;
          spaceSelect.appendChild(option);
        });
        spaceSelect.disabled = false;
      } else {
        spaceSelect.innerHTML = '<option value="">暂无可用停车位</option>';
        spaceSelect.disabled = true;
        showError('加载失败', '该停车场暂无可用停车位');
      }
    } catch (error) {
      console.error('加载停车位失败:', error);
      spaceSelect.innerHTML = '<option value="">加载失败，请重试</option>';
      spaceSelect.disabled = true;
      showError('加载失败', '无法加载停车位列表，请稍后重试');
    }
  }
  
  // 车辆入场表单提交
  document.getElementById('entry-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // ========== 前端验证（提交前） ==========
    
    const formData = new FormData(this);
    let plate = formData.get('license_plate');
    
    // 1. 验证车牌号（必填）
    if (!plate) {
      // 尝试从车牌网格获取
      const plateGrid = document.querySelector('[data-plate-grid-for="entry-plate"]');
      if (plateGrid) {
        const plateCells = plateGrid.querySelectorAll('.plate-cell');
        plate = Array.from(plateCells).map(cell => cell.textContent.trim()).join('');
      }
    }
    
    if (!plate || plate.trim() === '') {
      showError('入场失败', '请输入车牌号');
      const plateGrid = document.querySelector('[data-plate-grid-for="entry-plate"]');
      if (plateGrid) {
        const firstCell = plateGrid.querySelector('.plate-cell');
        if (firstCell) firstCell.focus();
      }
      return;
    }
    
    plate = plate.toUpperCase().trim();
    
    // 验证车牌号格式（7位普通车牌或8位新能源车牌）
    const plateRegex = /^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领][A-Z][A-HJ-NP-Z0-9]{4,5}[A-HJ-NP-Z0-9挂学警港澳]$/;
    if (!plateRegex.test(plate)) {
      showError('入场失败', '车牌号格式不正确，请输入有效的车牌号');
      const plateGrid = document.querySelector('[data-plate-grid-for="entry-plate"]');
      if (plateGrid) {
        const firstCell = plateGrid.querySelector('.plate-cell');
        if (firstCell) firstCell.focus();
      }
      return;
    }
    
    // 2. 验证停车场（必填）
    const lotId = formData.get('parking_lot');
    if (!lotId) {
      showError('入场失败', '请选择停车场');
      const lotSelect = document.getElementById('entry-lot');
      if (lotSelect) lotSelect.focus();
      return;
    }
    
    // 3. 验证停车位（必填）
    const spaceId = formData.get('parking_space_id');
    if (!spaceId) {
      showError('入场失败', '请选择停车位');
      const spaceSelect = document.getElementById('entry-space');
      if (spaceSelect) spaceSelect.focus();
      return;
    }
    
    // 4. 验证车辆类型（必填）
    const vehicleType = formData.get('vehicle_type');
    if (!vehicleType) {
      showError('入场失败', '请选择车辆类型');
      return;
    }
    
    // 所有验证通过，准备提交
    
    const submitBtn = document.getElementById('entry-submit-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';
    
    try {
      const result = await apiRequest('/parking/api/entry/', 'POST', {
        license_plate: plate,
        parking_lot_id: lotId,
        vehicle_type: vehicleType,
        parking_space_id: spaceId,
      });
      
      if (result.success) {
        closeModal('entry-modal');
        showSuccess('入场登记成功', 
          `车牌 ${result.data.license_plate} 已入场\n停车场：${result.data.parking_lot}\n车位号：${result.data.space_number}`);
        
        // 更新仪表盘数据（不刷新整个页面）
        updateDashboardDataFromModal();
      } else {
        showError('入场失败', result.message);
      }
    } catch (error) {
      showError('入场失败', '网络错误，请稍后重试');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>确认入场';
    }
  });
  
  // 更新仪表盘数据（AJAX，不刷新整个页面）
  async function updateDashboardDataFromModal() {
    try {
      const statsResult = await apiRequest('/parking/api/stats/');
      if (statsResult.success) {
        const data = statsResult.data;
        
        // 更新统计卡片中的数字（使用data-count属性）
        const countUpElements = document.querySelectorAll('.count-up[data-count]');
        countUpElements.forEach(el => {
          const dataCount = el.getAttribute('data-count');
          if (dataCount) {
            // 根据元素位置或父元素内容判断要更新哪个数据
            const parentText = el.closest('.stat-card')?.textContent || '';
            if (parentText.includes('总车位')) {
              el.setAttribute('data-count', data.total_spaces);
              animateNumberToElement(el, data.total_spaces);
            } else if (parentText.includes('已占用')) {
              el.setAttribute('data-count', data.occupied_spaces);
              animateNumberToElement(el, data.occupied_spaces);
            } else if (parentText.includes('空闲车位')) {
              el.setAttribute('data-count', data.available_spaces);
              animateNumberToElement(el, data.available_spaces);
            }
          }
        });
        
        // 更新今日统计区域
        const todayStats = document.querySelectorAll('.card-theme .font-number');
        todayStats.forEach(el => {
          const parentText = el.closest('div')?.textContent || '';
          if (parentText.includes('入场车辆')) {
            const parent = el.closest('.flex.items-center.justify-between');
            if (parent) {
              const countEl = parent.querySelector('.text-xl.font-bold');
              if (countEl) {
                animateNumberToElement(countEl, data.today_count);
              }
            }
          } else if (parentText.includes('在场车辆')) {
            const parent = el.closest('.flex.items-center.justify-between');
            if (parent) {
              const countEl = parent.querySelector('.text-xl.font-bold');
              if (countEl) {
                animateNumberToElement(countEl, data.active_count);
              }
            }
          } else if (parentText.includes('今日收入')) {
            const parent = el.closest('.flex.items-center.justify-between');
            if (parent) {
              const countEl = parent.querySelector('.text-xl.font-bold');
              if (countEl) {
                const revenue = parseFloat(data.today_revenue) || 0;
                animateNumberToElement(countEl, revenue, true);
              }
            }
          }
        });
        
        // 更新停车场列表（如果存在）
        if (data.parking_lots && Array.isArray(data.parking_lots)) {
          updateParkingLotsList(data.parking_lots);
        }
        
        // 更新最近记录（如果存在）
        if (data.recent_records && Array.isArray(data.recent_records)) {
          updateRecentRecords(data.recent_records);
        }
      }
    } catch (error) {
      console.error('更新仪表盘数据失败:', error);
    }
  }
  
  // 数字动画（针对元素）
  function animateNumberToElement(element, targetValue, isCurrency = false) {
    if (!element) return;
    
    const currentText = element.textContent.replace(/[^0-9.]/g, '');
    const currentValue = parseFloat(currentText) || 0;
    const increment = targetValue > currentValue ? 1 : -1;
    const duration = 500;
    const steps = Math.abs(targetValue - currentValue);
    const stepTime = steps > 0 ? duration / steps : 0;
    
    let current = currentValue;
    const timer = setInterval(() => {
      current += increment;
      if ((increment > 0 && current >= targetValue) || (increment < 0 && current <= targetValue)) {
        current = targetValue;
        clearInterval(timer);
      }
      if (isCurrency) {
        element.textContent = '¥' + Math.floor(current).toLocaleString();
      } else {
        element.textContent = Math.floor(current).toLocaleString();
      }
    }, stepTime);
  }
  
  // 更新停车场列表
  function updateParkingLotsList(lots) {
    // 查找停车场列表容器并更新
    const lotsSection = document.querySelector('[data-parking-lots-section]');
    if (lotsSection && lots.length > 0) {
      // 这里可以根据实际页面结构更新停车场列表
      console.log('更新停车场列表:', lots);
    }
  }
  
  // 更新最近记录
  function updateRecentRecords(records) {
    // 查找最近记录容器并更新
    const recordsSection = document.querySelector('[data-recent-records-section]');
    if (recordsSection && records.length > 0) {
      // 这里可以根据实际页面结构更新最近记录
      console.log('更新最近记录:', records);
    }
  }
  
  // 查询出场车辆
  async function searchForExit() {
    // ========== 前端验证（提交前） ==========
    
    let plate = document.getElementById('exit-plate').value.trim();
    if (!plate) {
      showError('查询失败', '请输入车牌号');
      document.getElementById('exit-plate').focus();
      return;
    }
    
    plate = plate.toUpperCase();
    
    // 验证车牌号格式（7位普通车牌或8位新能源车牌）
    const plateRegex = /^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领][A-Z][A-HJ-NP-Z0-9]{4,5}[A-HJ-NP-Z0-9挂学警港澳]$/;
    if (!plateRegex.test(plate)) {
      showError('查询失败', '车牌号格式不正确，请输入有效的车牌号');
      document.getElementById('exit-plate').focus();
      return;
    }
    
    // 显示加载状态
    document.getElementById('exit-loading').classList.remove('hidden');
    document.getElementById('exit-result').classList.add('hidden');
    document.getElementById('exit-not-found').classList.add('hidden');
    
    try {
      const result = await apiRequest(`/parking/api/query/?license_plate=${encodeURIComponent(plate)}`);
      
      document.getElementById('exit-loading').classList.add('hidden');
      
      if (result.success && result.data.found && result.data.is_parked) {
        const data = result.data;
        
        document.getElementById('exit-result').classList.remove('hidden');
        document.getElementById('exit-result-plate').textContent = data.license_plate;
        document.getElementById('exit-result-lot').textContent = data.parking_lot;
        document.getElementById('exit-result-space').textContent = data.space_number;
        document.getElementById('exit-result-entry').textContent = data.entry_time;
        
        // 计算停车时长
        const minutes = data.duration_minutes;
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        document.getElementById('exit-result-duration').textContent = 
          hours > 0 ? `${hours}小时${mins}分钟` : `${mins}分钟`;
        
        document.getElementById('exit-result-fee').textContent = `¥${data.current_fee}`;
        document.getElementById('exit-record-id').value = data.record_id;
      } else {
        document.getElementById('exit-not-found').classList.remove('hidden');
        document.getElementById('exit-error-msg').textContent = 
          result.data.is_parked === false ? '该车辆不在场内' : result.message;
      }
    } catch (error) {
      document.getElementById('exit-loading').classList.add('hidden');
      document.getElementById('exit-not-found').classList.remove('hidden');
      document.getElementById('exit-error-msg').textContent = '查询失败，请稍后重试';
    }
  }
  
  // 确认出场
  async function confirmExit() {
    // ========== 前端验证（提交前） ==========
    
    const recordId = document.getElementById('exit-record-id').value;
    if (!recordId) {
      showError('出场失败', '未找到有效的停车记录，请先查询车辆');
      return;
    }
    
    const plate = document.getElementById('exit-result-plate')?.textContent;
    if (!plate) {
      showError('出场失败', '未找到车辆信息，请先查询车辆');
      return;
    }
    
    // 所有验证通过，准备提交
    const confirmBtn = document.getElementById('exit-confirm-btn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';
    
    try {
      const result = await apiRequest('/parking/api/exit/', 'POST', {
        record_id: recordId,
        auto_pay: true,
      });
      
      if (result.success) {
        closeModal('exit-modal');
        showSuccess('出场成功', 
          `车牌 ${result.data.license_plate} 已出场\n停车费用：¥${result.data.fee}`);
        
        // 更新仪表盘数据（不刷新整个页面）
        updateDashboardDataFromModal();
      } else {
        showError('出场失败', result.message);
      }
    } catch (error) {
      showError('出场失败', '网络错误，请稍后重试');
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>确认结算';
    }
  }
  
  // 搜索车辆
  async function searchVehicle() {
    // ========== 前端验证（提交前） ==========
    
    let plate = document.getElementById('search-plate').value.trim();
    if (!plate) {
      showError('查询失败', '请输入车牌号');
      document.getElementById('search-plate').focus();
      return;
    }
    
    plate = plate.toUpperCase();
    
    // 验证车牌号格式（7位普通车牌或8位新能源车牌）
    const plateRegex = /^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领][A-Z][A-HJ-NP-Z0-9]{4,5}[A-HJ-NP-Z0-9挂学警港澳]$/;
    if (!plateRegex.test(plate)) {
      showError('查询失败', '车牌号格式不正确，请输入有效的车牌号');
      document.getElementById('search-plate').focus();
      return;
    }
    
    const resultsDiv = document.getElementById('search-results');
    const loadingDiv = document.getElementById('search-loading');
    
    loadingDiv.classList.remove('hidden');
    resultsDiv.innerHTML = '';
    
    try {
      const result = await apiRequest(`/parking/api/query/?license_plate=${encodeURIComponent(plate)}`);
      
      loadingDiv.classList.add('hidden');
      
      if (result.success && result.data.found) {
        const data = result.data;
        
        let statusHtml, statusText;
        if (data.is_parked) {
          statusHtml = `
            <span class="ml-auto px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 text-xs rounded-full">
              停车中
            </span>`;
          statusText = `
            <p><i class="fas fa-parking mr-2 text-theme-muted"></i>${data.parking_lot} · ${data.space_number}</p>
            <p><i class="far fa-clock mr-2 text-theme-muted"></i>入场时间：${data.entry_time}</p>
            <p><i class="fas fa-coins mr-2 text-theme-muted"></i>当前费用：<span class="text-amber-500">¥${data.current_fee}</span></p>`;
        } else {
          statusHtml = `
            <span class="ml-auto px-2 py-1 bg-slate-100 dark:bg-slate-900/30 text-slate-600 dark:text-slate-400 text-xs rounded-full">
              不在场内
            </span>`;
          statusText = data.last_visit ? 
            `<p><i class="far fa-clock mr-2 text-theme-muted"></i>上次离场：${data.last_visit}</p>
             <p><i class="fas fa-parking mr-2 text-theme-muted"></i>上次停车：${data.last_lot || '未知'}</p>` :
            `<p class="text-theme-muted">暂无停车记录</p>`;
        }
        
        resultsDiv.innerHTML = `
          <div class="p-4 bg-theme-secondary rounded-xl">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center">
                <i class="fas fa-car text-blue-500"></i>
              </div>
              <div>
                <p class="font-mono font-bold text-theme-primary">${data.license_plate}</p>
                <p class="text-sm text-theme-muted">${data.vehicle_type || '小型车'}</p>
              </div>
              ${statusHtml}
            </div>
            <div class="text-sm text-theme-secondary space-y-1">
              ${statusText}
            </div>
          </div>
        `;
      } else {
        resultsDiv.innerHTML = `
          <div class="text-center py-8 text-theme-muted">
            <i class="fas fa-car text-4xl opacity-30 mb-3"></i>
            <p>未找到车牌 ${plate} 的信息</p>
          </div>
        `;
      }
    } catch (error) {
      loadingDiv.classList.add('hidden');
      resultsDiv.innerHTML = `
        <div class="text-center py-8 text-red-500">
          <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
          <p>查询失败，请稍后重试</p>
        </div>
      `;
    }
  }
  
  // 输入框回车触发搜索
  document.getElementById('exit-plate').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchForExit();
  });
  
  document.getElementById('search-plate').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchVehicle();
  });
  
  // 重置出场模态框状态
  function resetExitModal() {
    document.getElementById('exit-plate').value = '';
    document.getElementById('exit-result').classList.add('hidden');
    document.getElementById('exit-not-found').classList.add('hidden');
    document.getElementById('exit-loading').classList.add('hidden');
  }
  
  // 重置搜索模态框状态
  function resetSearchModal() {
    document.getElementById('search-plate').value = '';
    document.getElementById('search-loading').classList.add('hidden');
    document.getElementById('search-results').innerHTML = `
      <div class="text-center py-8 text-theme-muted">
        <i class="fas fa-search text-4xl opacity-30 mb-3"></i>
        <p>输入车牌号进行查询</p>
      </div>
    `;
  }
  
  // 模态框焦点管理
  let previousActiveElement = null;
  const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
  
  // 打开模态框（带焦点管理）
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    // 保存当前焦点元素
    previousActiveElement = document.activeElement;
    
    // 显示模态框
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // 防止背景滚动
    
    // 添加动画类
    const backdrop = modal;
    const content = modal.querySelector('.card-theme, .modal-content');
    if (backdrop) backdrop.classList.add('backdrop-enter');
    if (content) content.classList.add('modal-enter');
    
    // 延迟聚焦到第一个可聚焦元素
    setTimeout(() => {
      const firstFocusable = modal.querySelector(focusableElements);
      if (firstFocusable) {
        firstFocusable.focus();
      }
    }, 100);
    
    // Tab键循环焦点（限制在模态框内）
    const handleTabKey = (e) => {
      if (e.key !== 'Tab') return;
      
      const focusable = Array.from(modal.querySelectorAll(focusableElements))
        .filter(el => !el.disabled && el.offsetParent !== null);
      
      if (focusable.length === 0) return;
      
      const firstFocusable = focusable[0];
      const lastFocusable = focusable[focusable.length - 1];
      
      if (e.shiftKey) {
        if (document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable.focus();
        }
      } else {
        if (document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable.focus();
        }
      }
    };
    
    modal.addEventListener('keydown', handleTabKey);
    modal._handleTabKey = handleTabKey; // 保存引用以便移除
  }
  
  // 关闭模态框（恢复焦点）
  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    // 移除动画类，添加退出动画
    const backdrop = modal;
    const content = modal.querySelector('.card-theme, .modal-content');
    if (backdrop) {
      backdrop.classList.remove('backdrop-enter');
      backdrop.classList.add('backdrop-exit');
    }
    if (content) {
      content.classList.remove('modal-enter');
      content.classList.add('modal-exit');
    }
    
    // 移除Tab键处理
    if (modal._handleTabKey) {
      modal.removeEventListener('keydown', modal._handleTabKey);
      delete modal._handleTabKey;
    }
    
    // 延迟隐藏，等待动画完成
    setTimeout(() => {
      modal.classList.add('hidden');
      document.body.style.overflow = ''; // 恢复滚动
      
      // 恢复之前的焦点
      if (previousActiveElement && previousActiveElement.focus) {
        previousActiveElement.focus();
      }
      previousActiveElement = null;
    }, 200);
  }
  
  // 打开模态框时重置状态
  const originalOpenQuickEntry = window.openQuickEntry;
  window.openQuickEntry = function() {
    document.getElementById('entry-form').reset();
    document.getElementById('entry-plate-status').classList.add('hidden');
    document.getElementById('entry-plate-error').classList.add('hidden');
    document.getElementById('entry-space-field').classList.add('hidden');
    openModal('entry-modal');
    // 延迟聚焦到第一个输入框，确保plate-grid已初始化
    setTimeout(() => {
      const firstCell = document.querySelector('[data-plate-grid-for="entry-plate"] .plate-cell');
      if (firstCell) {
        firstCell.focus();
      }
    }, 300);
  };
  
  const originalOpenQuickExit = window.openQuickExit;
  window.openQuickExit = function() {
    resetExitModal();
    openModal('exit-modal');
    // 延迟聚焦到第一个输入框，确保plate-grid已初始化
    setTimeout(() => {
      const firstCell = document.querySelector('[data-plate-grid-for="exit-plate"] .plate-cell');
      if (firstCell) {
        firstCell.focus();
      }
    }, 300);
  };
  
  const originalOpenQuickSearch = window.openQuickSearch;
  window.openQuickSearch = function() {
    resetSearchModal();
    openModal('search-modal');
    // 延迟聚焦到第一个输入框，确保plate-grid已初始化
    setTimeout(() => {
      const firstCell = document.querySelector('[data-plate-grid-for="search-plate"] .plate-cell');
      if (firstCell) {
        firstCell.focus();
      }
    }, 300);
  };
  
  // 导出openModal和closeModal供全局使用
  window.openModal = openModal;
  window.closeModal = closeModal;
  
  // ESC键关闭模态框
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const openModals = document.querySelectorAll('.modal:not(.hidden)');
      openModals.forEach(modal => {
        const modalId = modal.id;
        if (modalId) closeModal(modalId);
      });
    }
  });
  
  // 点击背景关闭模态框
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal(modal.id);
      }
    });
  });
  
  // 导出更新函数供dashboard调用
  window.updateDashboardDataFromModal = updateDashboardDataFromModal;
</script>
