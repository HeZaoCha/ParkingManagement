{% load static %}
{# 快捷操作模态框组件 - 连接后端 API #}

{# 车辆入场模态框 #}
<div id="entry-modal" 
     class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 backdrop-enter"
     role="dialog"
     aria-modal="true"
     aria-labelledby="entry-modal-title"
     aria-describedby="entry-modal-description">
  <div class="card-theme rounded-2xl w-full max-w-md transform transition-all modal-enter">
    <div class="p-6 border-b border-theme">
      <div class="flex items-center justify-between">
        <h3 id="entry-modal-title" class="text-xl font-bold text-theme-primary flex items-center gap-2">
          <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-xl flex items-center justify-center" aria-hidden="true">
            <i class="fas fa-sign-in-alt text-emerald-500"></i>
          </div>
          车辆入场
        </h3>
        <button type="button"
                onclick="closeModal('entry-modal')" 
                class="p-2 text-theme-muted hover:text-theme-primary hover:bg-theme-hover rounded-lg transition-all hover:scale-110 active:scale-95 group"
                aria-label="关闭车辆入场对话框">
          <i class="fas fa-times group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>
        </button>
      </div>
      <p id="entry-modal-description" class="text-sm text-theme-muted mt-2 hidden">填写车辆信息完成入场登记</p>
    </div>
    
    <form id="entry-form" class="p-6 space-y-4" novalidate>
      {% csrf_token %}
      <div>
        <label for="entry-plate" class="block text-sm font-medium text-theme-secondary mb-2">车牌号码</label>
        <div class="relative space-y-2">
          <input type="hidden" 
                 id="entry-plate" 
                 name="license_plate" 
                 required 
                 data-plate-field="true" 
                 class="input-focus-enhanced"
                 aria-describedby="entry-plate-hint entry-plate-error"
                 aria-invalid="false"
                 aria-required="true">
          <div class="plate-grid" data-plate-grid-for="entry-plate" aria-label="车牌号输入"></div>
          <span id="entry-plate-status" class="absolute right-3 top-1/2 -translate-y-1/2 hidden animate-fade-in" aria-hidden="true">
            <i class="fas fa-check-circle text-emerald-500"></i>
          </span>
        </div>
        <p id="entry-plate-hint" class="text-xs text-theme-muted mt-1">支持普通车牌（7位）和新能源车牌（8位）</p>
        <p id="entry-plate-error" class="text-red-500 text-sm mt-1 hidden animate-slide-up" role="alert" aria-live="polite"></p>
      </div>
      
      <div>
        <label for="entry-lot" class="block text-sm font-medium text-theme-secondary mb-2">选择停车场</label>
        <select id="entry-lot" 
                name="parking_lot" 
                required
                class="input-theme input-focus-enhanced w-full px-4 py-3 rounded-xl transition-all cursor-pointer"
                onchange="loadAvailableSpaces(this.value)"
                aria-describedby="entry-lot-hint"
                aria-required="true">
          <option value="">请选择停车场</option>
          {% for lot in parking_lots %}
            {% if lot.available_spaces > 0 %}
              <option value="{{ lot.id }}">{{ lot.name }} (剩余{{ lot.available_spaces }}位)</option>
            {% endif %}
          {% endfor %}
        </select>
        <p id="entry-lot-hint" class="text-xs text-theme-muted mt-1">选择车辆要停放的停车场</p>
      </div>
      
      <div id="entry-space-field" class="hidden animate-slide-up">
        <label class="block text-sm font-medium text-theme-secondary mb-2">
          选择停车位 <span class="text-red-500">*</span>
        </label>
        <select id="entry-space" name="parking_space_id"
                class="input-theme input-focus-enhanced w-full px-4 py-3 rounded-xl transition-all cursor-pointer"
                required>
          <option value="">请选择停车位（必选）</option>
        </select>
        <p class="text-theme-muted text-xs mt-1 flex items-center gap-1">
          <i class="fas fa-info-circle"></i>
          请选择车辆实际停放的停车位，确保记录准确
        </p>
      </div>
      
      <div>
        <fieldset>
          <legend class="block text-sm font-medium text-theme-secondary mb-2">车辆类型</legend>
          <div class="grid grid-cols-4 gap-2" role="radiogroup" aria-labelledby="vehicle-type-label">
            <label class="relative cursor-pointer">
              <input type="radio" 
                     name="vehicle_type" 
                     value="car" 
                     class="peer sr-only" 
                     checked
                     aria-describedby="vehicle-type-hint">
              <div class="p-3 border border-theme rounded-xl text-center transition-all
                          peer-checked:border-primary-500 peer-checked:bg-primary-50 dark:peer-checked:bg-primary-900/20
                          hover:bg-theme-hover">
                <i class="fas fa-car text-xl text-blue-500" aria-hidden="true"></i>
                <p class="text-xs text-theme-muted mt-1">轿车</p>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" 
                     name="vehicle_type" 
                     value="suv" 
                     class="peer sr-only"
                     aria-describedby="vehicle-type-hint">
              <div class="p-3 border border-theme rounded-xl text-center transition-all
                          peer-checked:border-primary-500 peer-checked:bg-primary-50 dark:peer-checked:bg-primary-900/20
                          hover:bg-theme-hover">
                <i class="fas fa-truck-pickup text-xl text-emerald-500" aria-hidden="true"></i>
                <p class="text-xs text-theme-muted mt-1">SUV</p>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" 
                     name="vehicle_type" 
                     value="motorcycle" 
                     class="peer sr-only"
                     aria-describedby="vehicle-type-hint">
              <div class="p-3 border border-theme rounded-xl text-center transition-all
                          peer-checked:border-primary-500 peer-checked:bg-primary-50 dark:peer-checked:bg-primary-900/20
                          hover:bg-theme-hover">
                <i class="fas fa-motorcycle text-xl text-amber-500" aria-hidden="true"></i>
                <p class="text-xs text-theme-muted mt-1">摩托</p>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" 
                     name="vehicle_type" 
                     value="truck" 
                     class="peer sr-only"
                     aria-describedby="vehicle-type-hint">
              <div class="p-3 border border-theme rounded-xl text-center transition-all
                          peer-checked:border-primary-500 peer-checked:bg-primary-50 dark:peer-checked:bg-primary-900/20
                          hover:bg-theme-hover">
                <i class="fas fa-truck text-xl text-red-500" aria-hidden="true"></i>
                <p class="text-xs text-theme-muted mt-1">货车</p>
              </div>
            </label>
          </div>
          <p id="vehicle-type-hint" class="text-xs text-theme-muted mt-1">选择车辆类型以确定收费标准</p>
        </fieldset>
      </div>
      
      <div class="pt-4 flex gap-3">
          <button type="button" 
                  onclick="closeModal('entry-modal')"
                  class="btn-interactive flex-1 px-4 py-3 border border-theme text-theme-secondary rounded-xl hover:bg-theme-hover font-medium transition-all group"
                  aria-label="取消车辆入场">
          <i class="fas fa-times mr-2 group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>取消
        </button>
        <button type="submit" 
                id="entry-submit-btn"
                class="btn-interactive ripple-effect flex-1 px-4 py-3 btn-primary rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-all group"
                aria-label="确认车辆入场">
          <i class="fas fa-check mr-2 group-hover:scale-110 transition-transform duration-200" aria-hidden="true"></i>确认入场
        </button>
      </div>
    </form>
  </div>
</div>

{# 车辆出场模态框 #}
<div id="exit-modal" 
     class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 backdrop-enter"
     role="dialog"
     aria-modal="true"
     aria-labelledby="exit-modal-title"
     aria-describedby="exit-modal-description">
  <div class="card-theme rounded-2xl w-full max-w-md transform transition-all modal-enter">
    <div class="p-6 border-b border-theme">
      <div class="flex items-center justify-between">
        <h3 id="exit-modal-title" class="text-xl font-bold text-theme-primary flex items-center gap-2">
          <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center" aria-hidden="true">
            <i class="fas fa-sign-out-alt text-blue-500"></i>
          </div>
          车辆出场
        </h3>
        <button type="button"
                onclick="closeModal('exit-modal')" 
                class="p-2 text-theme-muted hover:text-theme-primary hover:bg-theme-hover rounded-lg transition-all hover:scale-110 active:scale-95 group"
                aria-label="关闭车辆出场对话框">
          <i class="fas fa-times group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>
        </button>
      </div>
      <p id="exit-modal-description" class="text-sm text-theme-muted mt-2 hidden">输入车牌号查询并完成出场登记</p>
    </div>
    
    <div class="p-6 space-y-4">
      <div>
        <label for="exit-plate" class="block text-sm font-medium text-theme-secondary mb-2">车牌号码</label>
        <div class="relative">
          <input type="hidden" id="exit-plate" data-plate-field="true">
          <div class="plate-grid" data-plate-grid-for="exit-plate"></div>
          <button type="button" onclick="searchForExit()" id="exit-search-btn"
                  class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-all hover:scale-110 active:scale-95 group">
            <i class="fas fa-search group-hover:rotate-90 transition-transform duration-300"></i>
          </button>
        </div>
      </div>
      
      {# 加载中 #}
      <div id="exit-loading" class="hidden text-center py-8">
        <i class="fas fa-spinner fa-spin text-4xl text-primary-500 mb-3"></i>
        <p class="text-theme-muted">正在查询...</p>
      </div>
      
      {# 查询结果区域 #}
      <div id="exit-result" 
           class="hidden"
           role="region"
           aria-labelledby="exit-result-title"
           aria-live="polite">
        <h4 id="exit-result-title" class="sr-only">车辆出场信息</h4>
        <div class="p-4 bg-theme-secondary rounded-xl space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-theme-muted">车牌号</span>
            <span id="exit-result-plate" class="font-mono font-bold text-theme-primary" aria-live="polite">-</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-theme-muted">停车场</span>
            <span id="exit-result-lot" class="text-theme-secondary" aria-live="polite">-</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-theme-muted">车位号</span>
            <span id="exit-result-space" class="text-theme-secondary" aria-live="polite">-</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-theme-muted">入场时间</span>
            <span id="exit-result-entry" class="text-theme-secondary" aria-live="polite">-</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-theme-muted">停车时长</span>
            <span id="exit-result-duration" class="text-theme-secondary" aria-live="polite">-</span>
          </div>
          <div class="border-t border-theme pt-3 flex items-center justify-between">
            <span class="text-lg font-medium text-theme-primary">应付费用</span>
            <span id="exit-result-fee" class="text-2xl font-bold text-amber-500" aria-live="polite">¥0.00</span>
          </div>
        </div>
        <input type="hidden" id="exit-record-id" value="">
        
        <div class="pt-4 flex gap-3">
          <button type="button" 
                  onclick="closeModal('exit-modal')"
                  class="btn-interactive flex-1 px-4 py-3 border border-theme text-theme-secondary rounded-xl hover:bg-theme-hover font-medium transition-all group"
                  aria-label="取消车辆出场">
            <i class="fas fa-times mr-2 group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>取消
          </button>
          <button type="button" 
                  onclick="confirmExit()" 
                  id="exit-confirm-btn"
                  class="btn-interactive ripple-effect flex-1 px-4 py-3 btn-primary rounded-xl font-medium transition-all group"
                  aria-label="确认结算并出场">
            <i class="fas fa-credit-card mr-2 group-hover:scale-110 transition-transform duration-200" aria-hidden="true"></i>确认结算
          </button>
        </div>
      </div>
      
      {# 未找到提示 #}
      <div id="exit-not-found" 
           class="hidden text-center py-8"
           role="alert"
           aria-live="polite">
        <div class="w-16 h-16 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center mx-auto mb-3" aria-hidden="true">
          <i class="fas fa-exclamation-triangle text-2xl text-amber-500"></i>
        </div>
        <p class="text-theme-secondary" id="exit-error-msg">未找到该车辆的停车记录</p>
        <p class="text-theme-muted text-sm mt-1">请确认车牌号是否正确</p>
      </div>
    </div>
  </div>
</div>

{# 车辆查询模态框 #}
<div id="search-modal" 
     class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 backdrop-enter"
     role="dialog"
     aria-modal="true"
     aria-labelledby="search-modal-title"
     aria-describedby="search-modal-description">
  <div class="card-theme rounded-2xl w-full max-w-lg transform transition-all modal-enter">
    <div class="p-6 border-b border-theme">
      <div class="flex items-center justify-between">
        <h3 id="search-modal-title" class="text-xl font-bold text-theme-primary flex items-center gap-2">
          <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center" aria-hidden="true">
            <i class="fas fa-search text-purple-500"></i>
          </div>
          车辆查询
        </h3>
        <button type="button"
                onclick="closeModal('search-modal')" 
                class="p-2 text-theme-muted hover:text-theme-primary hover:bg-theme-hover rounded-lg transition-all hover:scale-110 active:scale-95 group"
                aria-label="关闭车辆查询对话框">
          <i class="fas fa-times group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>
        </button>
      </div>
      <p id="search-modal-description" class="text-sm text-theme-muted mt-2 hidden">输入车牌号查询车辆停车信息</p>
    </div>
    
    <div class="p-6 space-y-4">
      <div>
        <label for="search-plate" class="block text-sm font-medium text-theme-secondary mb-2">车牌号码</label>
        <div class="relative">
          <input type="hidden" 
                 id="search-plate" 
                 name="license_plate"
                 data-plate-field="true"
                 aria-describedby="search-plate-hint"
                 aria-required="true">
          <div class="plate-grid" data-plate-grid-for="search-plate" aria-label="车牌号输入"></div>
          <button type="button" 
                  onclick="searchVehicle()" 
                  id="search-btn"
                  class="btn-interactive absolute right-2 top-1/2 -translate-y-1/2 p-2 text-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-all group"
                  aria-label="查询车辆信息">
            <i class="fas fa-search group-hover:rotate-90 transition-transform duration-300" aria-hidden="true"></i>
          </button>
        </div>
        <p id="search-plate-hint" class="text-xs text-theme-muted mt-1">输入车牌号查询停车记录</p>
      </div>
      
      {# 加载中 #}
      <div id="search-loading" 
           class="hidden text-center py-8"
           role="status"
           aria-live="polite"
           aria-label="正在查询车辆信息">
        <i class="fas fa-spinner fa-spin text-4xl text-primary-500 mb-3" aria-hidden="true"></i>
        <p class="text-theme-muted">正在查询...</p>
      </div>
      
      {# 查询结果列表 #}
      <div id="search-results" 
           class="max-h-80 overflow-y-auto space-y-2"
           role="region"
           aria-labelledby="search-results-title"
           aria-live="polite">
        <h4 id="search-results-title" class="sr-only">查询结果</h4>
        <div class="text-center py-8 text-theme-muted" aria-live="polite">
          <i class="fas fa-search text-4xl opacity-30 mb-3" aria-hidden="true"></i>
          <p>输入车牌号进行查询</p>
        </div>
      </div>
    </div>
  </div>
</div>

{# 操作成功提示模态框 #}
<div id="success-modal" class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 backdrop-enter">
  <div class="card-theme rounded-2xl w-full max-w-sm text-center p-8 transform transition-all modal-enter">
    <div class="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
      <i class="fas fa-check text-3xl text-emerald-500"></i>
    </div>
    <h3 class="text-xl font-bold text-theme-primary mb-2" id="success-title">操作成功</h3>
    <p class="text-theme-muted mb-6" id="success-message">-</p>
    <button onclick="closeModal('success-modal')"
            class="btn-interactive ripple-effect w-full px-4 py-3 btn-primary rounded-xl font-medium transition-all">
      确定
    </button>
  </div>
</div>

{# 操作错误提示模态框 #}
<div id="error-modal" class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 backdrop-enter">
  <div class="card-theme rounded-2xl w-full max-w-sm text-center p-8 transform transition-all modal-enter">
    <div class="w-20 h-20 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
      <i class="fas fa-times text-3xl text-red-500"></i>
    </div>
    <h3 class="text-xl font-bold text-theme-primary mb-2" id="error-title">操作失败</h3>
    <p class="text-theme-muted mb-6" id="error-message">-</p>
    <button onclick="closeModal('error-modal');"
            class="btn-interactive ripple-effect w-full px-4 py-3 btn-primary rounded-xl font-medium transition-all">
      确定
    </button>
  </div>
</div>

{# 模态框脚本 - 连接后端 API #}


<script src="{% static 'components/quick_modals/js/script.js' %}"></script>