{% extends 'base.html' %}

{% block title %}停车场管理系统 - 注册{% endblock %}

{% block body_class %}min-h-screen flex items-center justify-center p-4 relative overflow-hidden overflow-y-auto{% endblock %}

{% block extra_css %}
<style>
  .register-bg {
    position: absolute;
    inset: 0;
    background: linear-gradient(-45deg, var(--gradient-start), var(--gradient-end), var(--color-primary-400), var(--color-primary-700));
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
  }
  
  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  
  .register-card {
    animation: cardEnter 0.6s ease-out;
  }
  
  @keyframes cardEnter {
    from {
      opacity: 0;
      transform: translateY(30px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  /* 步骤指示器样式 */
  .step-indicator {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    position: relative;
  }
  
  .step-indicator::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--border-color, #e5e7eb);
    z-index: 0;
  }
  
  .dark .step-indicator::before {
    background: var(--border-color-dark, #374151);
  }
  
  .step-item {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
  }
  
  .step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    transition: all 0.3s ease;
    background: var(--bg-secondary, #f3f4f6);
    color: var(--text-secondary, #6b7280);
    border: 2px solid var(--border-color, #e5e7eb);
  }
  
  .dark .step-number {
    background: var(--bg-secondary-dark, #2a2a2a);
    color: var(--text-secondary-dark, #9ca3af);
    border-color: var(--border-color-dark, #374151);
  }
  
  .step-item.active .step-number {
    background: var(--color-primary-500);
    color: white;
    border-color: var(--color-primary-500);
    transform: scale(1.1);
  }
  
  .step-item.completed .step-number {
    background: var(--color-primary-500);
    color: white;
    border-color: var(--color-primary-500);
  }
  
  .step-item.completed .step-number::after {
    content: '✓';
    font-size: 20px;
  }
  
  .step-title {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-secondary, #6b7280);
    text-align: center;
  }
  
  .dark .step-title {
    color: var(--text-secondary-dark, #9ca3af);
  }
  
  .step-item.active .step-title {
    color: var(--color-primary-500);
    font-weight: 600;
  }
  
  /* 步骤内容区域 */
  .step-content {
    display: none;
    animation: fadeIn 0.3s ease-in;
  }
  
  .step-content.active {
    display: block;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* 确保电话号码输入框的区号显示在国旗区域 */
  .iti__selected-flag {
    width: auto !important;
    padding-right: 8px !important;
  }
  
  .iti__selected-dial-code {
    display: inline-block !important;
    margin-left: 6px !important;
    font-weight: 500 !important;
    color: var(--text-primary, #111827) !important;
    font-size: 14px !important;
  }
  
  .dark .iti__selected-dial-code {
    color: var(--text-primary-dark, #f9fafb) !important;
  }
  
  /* 确保输入框有足够的左边距为国旗和区号留出空间 */
  .iti__flag-container + input,
  .iti input {
    padding-left: 90px !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="register-bg"></div>

<div class="w-full max-w-md relative z-10">
  <div class="register-card card-theme rounded-2xl overflow-hidden backdrop-blur-xl bg-opacity-90">
    <div class="bg-gradient-theme p-8 text-center relative overflow-hidden">
      <div class="absolute inset-0 bg-black/10"></div>
      <div class="relative z-10">
        <div class="w-20 h-20 mx-auto mb-4 bg-white/20 backdrop-blur rounded-2xl flex items-center justify-center shadow-lg">
          <i class="fas fa-user-plus text-white text-4xl"></i>
        </div>
        <h1 class="text-2xl font-bold text-white text-shadow">用户注册</h1>
        <p class="text-white/80 mt-2 text-sm">创建您的账户</p>
      </div>
    </div>

    <div class="p-8 max-h-[calc(100vh-200px)] overflow-y-auto">
      <!-- 步骤指示器 -->
      <div class="step-indicator">
        <div class="step-item active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-title">基本信息</div>
        </div>
        <div class="step-item" data-step="2">
          <div class="step-number">2</div>
          <div class="step-title">验证信息</div>
        </div>
        <div class="step-item" data-step="3">
          <div class="step-number">3</div>
          <div class="step-title">设置密码</div>
        </div>
      </div>

      <form id="register-form">
        {% csrf_token %}
        
        <!-- 步骤1: 基本信息 -->
        <div class="step-content active" id="step-1">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-theme-secondary mb-2" for="username-input">用户名</label>
              <div class="relative">
                <input type="text" name="username" id="username-input" required 
                       minlength="3" maxlength="20"
                       class="input-theme w-full px-4 py-3 rounded-xl pr-12"
                       placeholder="3-20个字符，支持所有字符类型"
                       aria-describedby="username-hint username-error"
                       aria-invalid="false"
                       aria-required="true">
                <div id="username-validation-icon" class="absolute right-3 top-1/2 -translate-y-1/2 hidden pointer-events-none z-10">
                  <i class="fas fa-check-circle text-green-500 text-lg" id="username-valid-icon"></i>
                  <i class="fas fa-times-circle text-red-500 text-lg" id="username-invalid-icon"></i>
                </div>
              </div>
              <div id="username-hint" class="text-xs text-theme-muted mt-1">
                <i class="fas fa-info-circle mr-1"></i>
                用户名长度限制为3-20个字符，支持中文、英文、数字、特殊字符等所有字符类型
              </div>
              <div id="username-error" class="text-xs text-red-500 mt-1 hidden" role="alert" aria-live="polite"></div>
            </div>

            <div>
              <fieldset>
                <legend class="block text-sm font-medium text-theme-secondary mb-2">验证方式</legend>
                <div class="flex gap-4" role="radiogroup" aria-labelledby="verification-type-label">
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" 
                           name="code_type" 
                           value="email" 
                           checked 
                           autocomplete="off" 
                           class="mr-2"
                           aria-describedby="verification-type-hint">
                    <span>邮箱验证</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" 
                           name="code_type" 
                           value="phone" 
                           autocomplete="off" 
                           class="mr-2"
                           aria-describedby="verification-type-hint">
                    <span>手机验证</span>
                  </label>
                </div>
                <p id="verification-type-hint" class="text-xs text-theme-muted mt-1">选择邮箱或手机号接收验证码</p>
              </fieldset>
            </div>

            <button type="button" onclick="nextStep()" class="w-full btn-primary py-3 px-4 rounded-xl font-medium">
              下一步 <i class="fas fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>

        <!-- 步骤2: 验证信息 -->
        <div class="step-content" id="step-2">
          <div class="space-y-4">
            <div id="email-field">
              <label class="block text-sm font-medium text-theme-secondary mb-2">邮箱</label>
              <div class="flex gap-2">
                <input type="email" name="email" id="email-input"
                       class="input-theme flex-1 px-4 py-3 rounded-xl"
                       placeholder="your@email.com">
                <button type="button" onclick="sendVerificationCode()" id="send-code-btn"
                        class="px-4 py-3 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-colors whitespace-nowrap">
                  发送验证码
                </button>
              </div>
              <div id="email-error" class="text-xs text-red-500 mt-1 hidden" role="alert" aria-live="polite"></div>
            </div>

            <div id="phone-field" class="hidden">
              <label class="block text-sm font-medium text-theme-secondary mb-2" for="phone-input">
                手机号 <span class="text-red-500">*</span>
              </label>
              <div id="phone-hint" class="text-xs text-theme-muted mb-2">
                <i class="fas fa-info-circle mr-1"></i>
                请选择国家/地区，区号将显示在国旗区域
              </div>
              <div class="flex gap-2">
                <div class="flex-1 relative">
                  <input type="tel" 
                         name="phone" 
                         id="phone-input"
                         autocomplete="tel"
                         class="input-theme w-full px-4 py-3 rounded-xl"
                         aria-describedby="phone-hint phone-error"
                         aria-invalid="false"
                         aria-required="true">
                  <div id="phone-validation-icon" class="absolute right-3 top-1/2 -translate-y-1/2 hidden pointer-events-none z-10">
                    <i class="fas fa-check-circle text-green-500 text-lg" id="phone-valid-icon"></i>
                    <i class="fas fa-times-circle text-red-500 text-lg" id="phone-invalid-icon"></i>
                  </div>
                </div>
                <button type="button" onclick="sendVerificationCode()" id="send-code-btn-phone"
                        class="px-4 py-3 bg-primary-500 text-white rounded-xl hover:bg-primary-600 transition-colors whitespace-nowrap">
                  发送验证码
                </button>
              </div>
              <div id="phone-error" class="text-xs text-red-500 mt-1 hidden" role="alert" aria-live="polite"></div>
            </div>

            <div>
              <label for="verification-code-input" class="block text-sm font-medium text-theme-secondary mb-2">验证码</label>
              <input type="text" 
                     name="verification_code" 
                     id="verification-code-input"
                     required
                     class="input-theme w-full px-4 py-3 rounded-xl"
                     placeholder="请输入验证码"
                     autocomplete="one-time-code"
                     aria-describedby="verification-code-hint"
                     aria-required="true"
                     maxlength="6"
                     inputmode="numeric"
                     pattern="[0-9]{6}">
              <p id="verification-code-hint" class="text-xs text-theme-muted mt-1">请输入6位数字验证码</p>
              <div id="verification-code-error" class="text-xs text-red-500 mt-1 hidden" role="alert" aria-live="polite"></div>
            </div>

            <div class="flex gap-3">
              <button type="button" onclick="prevStep()" class="flex-1 btn-secondary py-3 px-4 rounded-xl font-medium">
                <i class="fas fa-arrow-left mr-2"></i>上一步
              </button>
              <button type="button" onclick="nextStep()" class="flex-1 btn-primary py-3 px-4 rounded-xl font-medium">
                下一步 <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- 步骤3: 设置密码 -->
        <div class="step-content" id="step-3">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-theme-secondary mb-2" for="password-input">密码</label>
              <input type="password" name="password" id="password-input" required
                     minlength="8" maxlength="128"
                     class="input-theme w-full px-4 py-3 rounded-xl"
                     placeholder="至少8个字符，建议使用passphrase（多个单词组合）"
                     aria-describedby="password-hint"
                     aria-required="true">
              <div id="password-hint" class="text-xs text-theme-muted mt-1">
                <i class="fas fa-info-circle mr-1"></i>
                密码长度8-128个字符，支持所有字符类型（包括空格和特殊字符）。建议使用passphrase（多个单词组合）以提高安全性和易记性
              </div>
              <div id="password-error" class="text-xs text-red-500 mt-1 hidden" role="alert" aria-live="polite"></div>
            </div>

            <div>
              <label class="block text-sm font-medium text-theme-secondary mb-2">确认密码</label>
              <input type="password" name="password_confirm" id="password-confirm-input" required
                     class="input-theme w-full px-4 py-3 rounded-xl"
                     placeholder="请再次输入密码">
              <div id="password-confirm-error" class="text-xs text-red-500 mt-1 hidden" role="alert" aria-live="polite"></div>
            </div>

            <div class="flex gap-3">
              <button type="button" onclick="prevStep()" class="flex-1 btn-secondary py-3 px-4 rounded-xl font-medium">
                <i class="fas fa-arrow-left mr-2"></i>上一步
              </button>
              <button type="submit" class="flex-1 btn-primary py-3 px-4 rounded-xl font-medium">
                完成注册 <i class="fas fa-check ml-2"></i>
              </button>
            </div>
          </div>
        </div>
      </form>

      <div class="mt-6 text-center">
        <p class="text-theme-muted text-sm">
          已有账户？
          <a href="{% url 'login' %}" class="text-primary-500 hover:text-primary-600 font-medium">立即登录</a>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
// 当前步骤
let currentStep = 1;
const totalSteps = 3;

// 初始化国际手机号输入组件
let phoneInputInstance = null;

// 步骤切换函数
function showStep(step) {
  // 隐藏所有步骤内容
  document.querySelectorAll('.step-content').forEach(content => {
    content.classList.remove('active');
  });
  
  // 显示当前步骤
  const stepContent = document.getElementById(`step-${step}`);
  if (stepContent) {
    stepContent.classList.add('active');
  }
  
  // 更新步骤指示器
  document.querySelectorAll('.step-item').forEach((item, index) => {
    const stepNum = index + 1;
    item.classList.remove('active', 'completed');
    
    if (stepNum < step) {
      item.classList.add('completed');
    } else if (stepNum === step) {
      item.classList.add('active');
    }
  });
  
  currentStep = step;
}

function nextStep() {
  // 验证当前步骤
  if (currentStep === 1) {
    if (!validateStep1()) {
      return;
    }
  } else if (currentStep === 2) {
    if (!validateStep2()) {
      return;
    }
  }
  
  if (currentStep < totalSteps) {
    showStep(currentStep + 1);
  }
}

function prevStep() {
  if (currentStep > 1) {
    showStep(currentStep - 1);
  }
}

// 验证步骤1
function validateStep1() {
  const usernameInput = document.getElementById('username-input');
  const username = usernameInput.value.trim();
  
  if (!username) {
    showFieldError('username', '请输入用户名');
    usernameInput.focus();
    return false;
  }
  
  if (username.length < 3 || username.length > 20) {
    showFieldError('username', '用户名长度必须在3-20个字符之间');
    usernameInput.focus();
    return false;
  }
  
  // 检查用户名是否可用（异步，这里只做基本验证）
  clearFieldError('username');
  return true;
}

// 验证步骤2
function validateStep2() {
  const codeType = document.querySelector('input[name="code_type"]:checked')?.value;
  
  if (!codeType) {
    alert('请选择验证方式');
    return false;
  }
  
  if (codeType === 'email') {
    const emailInput = document.getElementById('email-input');
    const email = emailInput.value.trim();
    
    if (!email) {
      showFieldError('email', '请输入邮箱地址');
      emailInput.focus();
      return false;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showFieldError('email', '邮箱格式不正确');
      emailInput.focus();
      return false;
    }
    
    clearFieldError('email');
  } else if (codeType === 'phone') {
    const validation = validatePhoneNumber();
    if (!validation.valid) {
      showFieldError('phone', validation.message);
      const phoneInput = document.getElementById('phone-input');
      if (phoneInput) {
        phoneInput.focus();
        updatePhoneValidation(phoneInput);
      }
      return false;
    }
    clearFieldError('phone');
  }
  
  // 验证验证码
  const codeInput = document.getElementById('verification-code-input');
  const code = codeInput.value.trim();
  
  if (!code) {
    showFieldError('verification-code', '请输入验证码');
    codeInput.focus();
    return false;
  }
  
  if (!/^\d{6}$/.test(code)) {
    showFieldError('verification-code', '验证码必须是6位数字');
    codeInput.focus();
    return false;
  }
  
  clearFieldError('verification-code');
  return true;
}

// 初始化函数（在DOMContentLoaded中调用）
function initPhoneInput() {
  const phoneInput = document.getElementById('phone-input');
  
  if (phoneInput) {
    phoneInputInstance = window.intlTelInput(phoneInput, {
      initialCountry: 'cn',
      preferredCountries: ['cn', 'us', 'hk', 'tw', 'jp', 'kr', 'sg'],
      nationalMode: true, // 使用国家格式（输入框内不显示区号）
      formatAsYouType: true,
      autoPlaceholder: 'polite',
      placeholderNumberType: 'MOBILE',
      countrySearch: true,
      showSelectedDialCode: true, // 在国旗区域显示区号
      separateDialCode: true, // 将区号单独显示在国旗区域
      strictMode: true,
      loadUtils: () => import('https://cdn.jsdelivr.net/npm/intl-tel-input@25.13.1/build/js/utils.js'),
      containerClass: 'w-full',
      geoIpLookup: function(callback) {
        callback('cn');
      }
    });
    
    phoneInput.addEventListener('countrychange', function() {
      // 当使用 separateDialCode 时，区号会自动显示在国旗区域，输入框内只需要输入数字
      updatePhoneValidation(phoneInput);
    });
  }
}

// 验证手机号格式
function validatePhoneNumber() {
  const phoneInput = document.getElementById('phone-input');
  if (!phoneInput || !phoneInputInstance) {
    return { valid: false, message: '手机号输入框未初始化' };
  }
  
  const value = phoneInput.value.trim();
  
  if (!value) {
    return { valid: false, message: '请输入手机号' };
  }
  
  if (phoneInputInstance.isValidNumber()) {
    const fullNumber = phoneInputInstance.getNumber();
    return { valid: true, cleaned: fullNumber, isInternational: true };
  } else {
    const errorCode = phoneInputInstance.getValidationError();
    const errorMessages = {
      0: '手机号格式不正确',
      1: '国家代码无效',
      2: '号码过短',
      3: '号码过长',
      4: '号码格式不正确'
    };
    return { valid: false, message: errorMessages[errorCode] || '请输入有效的手机号' };
  }
}

// 更新手机号输入框验证状态
function updatePhoneValidation(phoneInput) {
  if (!phoneInputInstance) return;
  
  const errorDiv = document.getElementById('phone-error');
  const validationIcon = document.getElementById('phone-validation-icon');
  const validIcon = document.getElementById('phone-valid-icon');
  const invalidIcon = document.getElementById('phone-invalid-icon');
  
  const value = phoneInput.value.trim();
  
  if (!value) {
    errorDiv.classList.add('hidden');
    validationIcon.classList.add('hidden');
    phoneInput.setAttribute('aria-invalid', 'false');
    phoneInput.classList.remove('border-red-500', 'border-green-500');
    return;
  }
  
  const validation = validatePhoneNumber();
  
  if (validation.valid) {
    errorDiv.classList.add('hidden');
    validationIcon.classList.remove('hidden');
    validIcon.classList.remove('hidden');
    invalidIcon.classList.add('hidden');
    phoneInput.setAttribute('aria-invalid', 'false');
    phoneInput.classList.remove('border-red-500');
    phoneInput.classList.add('border-green-500');
  } else {
    errorDiv.textContent = validation.message;
    errorDiv.classList.remove('hidden');
    validationIcon.classList.remove('hidden');
    validIcon.classList.add('hidden');
    invalidIcon.classList.remove('hidden');
    phoneInput.setAttribute('aria-invalid', 'true');
    phoneInput.classList.remove('border-green-500');
    phoneInput.classList.add('border-red-500');
  }
}

// 初始化字段显示状态
function updateFieldVisibility() {
  const emailField = document.getElementById('email-field');
  const phoneField = document.getElementById('phone-field');
  const selectedCodeType = document.querySelector('input[name="code_type"]:checked');
  
  if (!emailField || !phoneField) return;
  
  if (selectedCodeType) {
    if (selectedCodeType.value === 'email') {
      emailField.classList.remove('hidden');
      phoneField.classList.add('hidden');
    } else {
      emailField.classList.add('hidden');
      phoneField.classList.remove('hidden');
    }
  } else {
    const emailRadio = document.querySelector('input[name="code_type"][value="email"]');
    if (emailRadio) {
      emailRadio.checked = true;
      emailField.classList.remove('hidden');
      phoneField.classList.add('hidden');
    }
  }
}

// 用户名验证和重复检查
let usernameCheckTimeout = null;

function validateUsernameLength(username) {
  const length = username.length;
  if (length < 3) {
    return { valid: false, message: '用户名至少需要3个字符' };
  }
  if (length > 20) {
    return { valid: false, message: '用户名不能超过20个字符' };
  }
  return { valid: true, message: '' };
}

async function checkUsernameAvailability(username) {
  if (!username || username.length < 3) {
    return { available: false, message: '用户名至少需要3个字符' };
  }
  
  try {
    const response = await fetch(`{% url "parking:api_check_username" %}?username=${encodeURIComponent(username)}`);
    const result = await response.json();
    return result;
  } catch (error) {
    console.error('检查用户名失败:', error);
    return { available: false, message: '检查用户名时出错，请稍后重试' };
  }
}

function updateUsernameValidation(usernameInput) {
  const errorDiv = document.getElementById('username-error');
  const validationIcon = document.getElementById('username-validation-icon');
  const validIcon = document.getElementById('username-valid-icon');
  const invalidIcon = document.getElementById('username-invalid-icon');
  
  const value = usernameInput.value.trim();
  
  errorDiv.classList.add('hidden');
  validationIcon.classList.add('hidden');
  usernameInput.setAttribute('aria-invalid', 'false');
  usernameInput.classList.remove('border-red-500', 'border-green-500');
  
  if (!value) {
    return;
  }
  
  const lengthValidation = validateUsernameLength(value);
  if (!lengthValidation.valid) {
    errorDiv.textContent = lengthValidation.message;
    errorDiv.classList.remove('hidden');
    validationIcon.classList.remove('hidden');
    invalidIcon.classList.remove('hidden');
    validIcon.classList.add('hidden');
    usernameInput.setAttribute('aria-invalid', 'true');
    usernameInput.classList.add('border-red-500');
    return;
  }
  
  checkUsernameAvailability(value).then(result => {
    if (result.available) {
      errorDiv.classList.add('hidden');
      validationIcon.classList.remove('hidden');
      validIcon.classList.remove('hidden');
      invalidIcon.classList.add('hidden');
      usernameInput.setAttribute('aria-invalid', 'false');
      usernameInput.classList.remove('border-red-500');
      usernameInput.classList.add('border-green-500');
    } else {
      errorDiv.textContent = result.message;
      errorDiv.classList.remove('hidden');
      validationIcon.classList.remove('hidden');
      invalidIcon.classList.remove('hidden');
      validIcon.classList.add('hidden');
      usernameInput.setAttribute('aria-invalid', 'true');
      usernameInput.classList.remove('border-green-500');
      usernameInput.classList.add('border-red-500');
    }
  });
}

// 显示字段错误
function showFieldError(fieldName, message) {
  const errorElement = document.getElementById(`${fieldName}-error`);
  if (errorElement) {
    errorElement.textContent = message;
    errorElement.classList.remove('hidden');
    errorElement.setAttribute('aria-live', 'polite');
  }
  
  const inputElement = document.getElementById(`${fieldName}-input`) || 
                       document.querySelector(`[name="${fieldName}"]`) ||
                       document.getElementById(`verification-code-input`);
  if (inputElement) {
    inputElement.classList.add('input-error');
    inputElement.setAttribute('aria-invalid', 'true');
  }
}

// 清除字段错误
function clearFieldError(fieldName) {
  const errorElement = document.getElementById(`${fieldName}-error`);
  if (errorElement) {
    errorElement.classList.add('hidden');
    errorElement.textContent = '';
  }
  
  const inputElement = document.getElementById(`${fieldName}-input`) || 
                       document.querySelector(`[name="${fieldName}"]`) ||
                       document.getElementById(`verification-code-input`);
  if (inputElement) {
    inputElement.classList.remove('input-error');
    inputElement.setAttribute('aria-invalid', 'false');
  }
}

document.addEventListener('DOMContentLoaded', function() {
  initPhoneInput();
  
  const codeTypeRadios = document.querySelectorAll('input[name="code_type"]');
  const phoneInput = document.getElementById('phone-input');
  const usernameInput = document.getElementById('username-input');
  
  updateFieldVisibility();
  
  if (usernameInput) {
    usernameInput.addEventListener('input', function(e) {
      const value = e.target.value;
      if (value.length > 20) {
        e.target.value = value.slice(0, 20);
      }
      
      clearTimeout(usernameCheckTimeout);
      usernameCheckTimeout = setTimeout(() => {
        updateUsernameValidation(usernameInput);
      }, 500);
    });
    
    usernameInput.addEventListener('blur', function() {
      clearTimeout(usernameCheckTimeout);
      updateUsernameValidation(usernameInput);
    });
  }
  
  if (phoneInput && phoneInputInstance) {
    phoneInput.addEventListener('input', function() {
      clearTimeout(phoneInput.validationTimeout);
      phoneInput.validationTimeout = setTimeout(() => {
        updatePhoneValidation(phoneInput);
      }, 300);
    });
    
    phoneInput.addEventListener('blur', function() {
      updatePhoneValidation(phoneInput);
    });
  }
  
  codeTypeRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      updateFieldVisibility();
      if (this.value === 'phone' && phoneInput) {
        setTimeout(() => phoneInput.focus(), 100);
      }
    });
  });
  
  // 表单提交处理
  const form = document.getElementById('register-form');
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // 验证所有步骤
    if (!validateStep1() || !validateStep2()) {
      // 如果验证失败，跳转到失败的步骤
      if (!validateStep1()) {
        showStep(1);
      } else if (!validateStep2()) {
        showStep(2);
      }
      return;
    }
    
    // 验证密码
    const passwordInput = document.getElementById('password-input');
    const password = passwordInput.value;
    if (!password) {
      showFieldError('password', '请输入密码');
      showStep(3);
      passwordInput.focus();
      return;
    }
    if (password.length < 8 || password.length > 128) {
      showFieldError('password', '密码长度必须在8-128个字符之间');
      showStep(3);
      passwordInput.focus();
      return;
    }
    clearFieldError('password');
    
    const confirmInput = document.getElementById('password-confirm-input');
    const confirmPassword = confirmInput.value;
    if (!confirmPassword) {
      showFieldError('password-confirm', '请再次输入密码');
      showStep(3);
      confirmInput.focus();
      return;
    }
    if (password !== confirmPassword) {
      showFieldError('password-confirm', '两次输入的密码不一致');
      showStep(3);
      confirmInput.focus();
      return;
    }
    clearFieldError('password-confirm');
    
    // 所有验证通过，准备提交
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    const codeType = document.querySelector('input[name="code_type"]:checked')?.value;
    if (codeType === 'phone' && data.phone && phoneInputInstance) {
      const fullNumber = phoneInputInstance.getNumber();
      if (fullNumber) {
        data.phone = fullNumber;
      }
    }
    
    try {
      const response = await fetch('{% url "parking:register" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      if (result.success) {
        alert('注册成功！');
        window.location.href = result.redirect_url || '/parking/customer/';
      } else {
        alert('注册失败：' + result.message);
      }
    } catch (error) {
      alert('注册失败，请稍后重试');
    }
  });
});

async function sendVerificationCode() {
  const codeType = document.querySelector('input[name="code_type"]:checked').value;
  let target;
  
  if (codeType === 'email') {
    target = document.getElementById('email-input').value;
    if (!target) {
      alert('请先输入邮箱');
      return;
    }
  } else {
    const phoneInput = document.getElementById('phone-input');
    
    if (!phoneInput || !phoneInput.value.trim()) {
      alert('请先输入手机号');
      if (phoneInput) phoneInput.focus();
      return;
    }
    
    const validation = validatePhoneNumber();
    if (!validation.valid) {
      alert(validation.message);
      phoneInput.focus();
      updatePhoneValidation(phoneInput);
      return;
    }
    
    if (phoneInputInstance) {
      target = phoneInputInstance.getNumber();
    } else {
      alert('手机号输入组件未初始化，请刷新页面重试');
      return;
    }
  }
  
  const btn = codeType === 'email' 
    ? document.getElementById('send-code-btn')
    : document.getElementById('send-code-btn-phone');
  
  btn.disabled = true;
  btn.textContent = '发送中...';
  
  try {
    const response = await fetch('{% url "parking:api_send_verification_code" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        code_type: codeType,
        target: target,
        purpose: 'register'
      })
    });
    
    const result = await response.json();
    
    if (response.status === 429 || (result.message && result.message.includes('频繁'))) {
      alert('发送过于频繁，请1分钟后再试');
      let countdown = 60;
      btn.textContent = `${countdown}秒后重发`;
      const timer = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          btn.textContent = `${countdown}秒后重发`;
        } else {
          clearInterval(timer);
          btn.disabled = false;
          btn.textContent = '发送验证码';
        }
      }, 1000);
      return;
    }
    
    if (result.success) {
      alert('验证码已发送！');
      let countdown = 60;
      btn.textContent = `${countdown}秒后重发`;
      const timer = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          btn.textContent = `${countdown}秒后重发`;
        } else {
          clearInterval(timer);
          btn.disabled = false;
          btn.textContent = '发送验证码';
        }
      }, 1000);
    } else {
      alert('发送失败：' + (result.message || '未知错误'));
      btn.disabled = false;
      btn.textContent = '发送验证码';
    }
  } catch (error) {
    console.error('发送验证码错误:', error);
    alert('发送失败，请稍后重试');
    btn.disabled = false;
    btn.textContent = '发送验证码';
  }
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  if (!cookieValue) {
    const metaTag = document.querySelector('meta[name=csrf-token]');
    if (metaTag) {
      cookieValue = metaTag.getAttribute('content');
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
