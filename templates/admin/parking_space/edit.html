{% extends 'admin/base.html' %}

{% block title %}{% if space %}编辑车位{% else %}新增车位{% endif %}{% endblock %}
{% block page_title %}{% if space %}编辑车位{% else %}新增车位{% endif %}{% endblock %}

{% block breadcrumb %}
<nav class="flex items-center gap-2 text-sm text-slate-400 ml-4" aria-label="面包屑导航">
    <a href="{% url 'parking:admin_index' %}" class="hover:text-white" aria-label="返回首页">首页</a>
    <i class="fas fa-chevron-right text-xs" aria-hidden="true"></i>
    <a href="{% url 'parking:admin_parking_space_list' %}" class="hover:text-white" aria-label="车位管理">车位管理</a>
    <i class="fas fa-chevron-right text-xs" aria-hidden="true"></i>
    <span class="text-slate-200" aria-current="page">{% if space %}编辑{% else %}新增{% endif %}</span>
</nav>
{% endblock %}

{% block content %}
<div class="max-w-2xl">
    <form method="post" class="space-y-6" novalidate data-validate onsubmit="return validateParkingSpaceForm(event)">
        {% csrf_token %}
        
        <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6 space-y-5" role="region" aria-labelledby="space-info-title">
            <h3 id="space-info-title" class="text-lg font-semibold text-white border-b border-slate-700/50 pb-4 mb-5">
                <i class="fas fa-square-parking text-primary-400 mr-2" aria-hidden="true"></i>
                车位信息
            </h3>
            
            <!-- 停车场 -->
            <div>
                <label for="parking-lot-select" class="block text-sm font-medium text-slate-300 mb-2">
                    所属停车场 <span class="text-red-400" aria-label="必填">*</span>
                </label>
                <select id="parking-lot-select"
                        name="parking_lot" 
                        required
                        class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                        aria-describedby="parking-lot-hint"
                        aria-required="true">
                    <option value="">请选择停车场</option>
                    {% for lot in lots %}
                    <option value="{{ lot.pk }}" 
                            {% if space.parking_lot_id == lot.pk or request.GET.lot == lot.pk|stringformat:"s" %}selected{% endif %}>
                        {{ lot.name }}
                    </option>
                    {% endfor %}
                </select>
                <p id="parking-lot-hint" class="mt-1 text-xs text-slate-500 sr-only">选择车位所属的停车场</p>
            </div>
            
            <!-- 车位号 -->
            <div>
                <label for="space-number-input" class="block text-sm font-medium text-slate-300 mb-2">
                    车位号 <span class="text-red-400" aria-label="必填">*</span>
                </label>
                <input type="text" 
                       id="space-number-input"
                       name="space_number" 
                       value="{{ space.space_number|default:'' }}" 
                       required
                       data-validation="required"
                       placeholder="如: A001, B012"
                       class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                       aria-describedby="space-number-hint space-number-input-error"
                       aria-required="true">
                <div id="space-number-input-error" class="text-xs text-red-500 mt-1 hidden" role="alert" aria-live="polite"></div>
                <p id="space-number-hint" class="mt-1 text-xs text-slate-500">请输入车位号，如：A001, B012</p>
            </div>
            
            <!-- 楼层（动态加载） -->
            <div id="floor-field" class="hidden" role="region" aria-labelledby="floor-title">
                <label id="floor-title" for="floor-select" class="block text-sm font-medium text-slate-300 mb-2">
                    所在楼层
                </label>
                <select name="floor" 
                        id="floor-select"
                        class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                        aria-describedby="floor-hint">
                    <option value="">无（露天停车场）</option>
                </select>
                <p id="floor-hint" class="mt-1 text-xs text-slate-500">选择车位所在楼层</p>
            </div>
            
            <!-- 区域（动态加载） -->
            <div id="area-field" class="hidden" role="region" aria-labelledby="area-title">
                <label id="area-title" for="area-select" class="block text-sm font-medium text-slate-300 mb-2">
                    所在区域
                </label>
                <select name="area" 
                        id="area-select"
                        class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                        aria-describedby="area-hint">
                    <option value="">无</option>
                </select>
                <p id="area-hint" class="mt-1 text-xs text-slate-500">选择车位所在区域</p>
            </div>
            
            <!-- 类型 -->
            <div>
                <label for="space-type-select" class="block text-sm font-medium text-slate-300 mb-2">
                    车位类型
                </label>
                <select id="space-type-select"
                        name="space_type"
                        class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                        aria-describedby="space-type-hint">
                    {% for value, label in space_types %}
                    <option value="{{ value }}" {% if space.space_type == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                <p id="space-type-hint" class="mt-1 text-xs text-slate-500 sr-only">选择车位类型</p>
            </div>
            
            <!-- 预约状态 -->
            <div>
                <label for="is-reserved-checkbox" class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" 
                           id="is-reserved-checkbox"
                           name="is_reserved" 
                           {% if space.is_reserved %}checked{% endif %}
                           class="w-5 h-5 rounded border-slate-600 bg-slate-900 text-primary-600 focus:ring-primary-500 focus:ring-offset-0"
                           aria-describedby="is-reserved-hint">
                    <span class="text-slate-300">已预约</span>
                </label>
                <p id="is-reserved-hint" class="mt-1 text-xs text-slate-500 ml-8">标记为已预约的车位不会分配给临时停车</p>
            </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="flex items-center gap-4" role="group" aria-label="表单操作">
            <button type="submit" 
                    class="btn-ripple inline-flex items-center gap-2 px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors"
                    aria-label="保存车位信息">
                <i class="fas fa-save" aria-hidden="true"></i>
                保存
            </button>
            <a href="{% url 'parking:admin_parking_space_list' %}" 
               class="px-6 py-3 text-slate-400 hover:text-white transition-colors"
               aria-label="取消并返回车位列表">
                取消
            </a>
        </div>
    </form>
</div>

<script>
// 根据选择的停车场加载楼层和区域
document.querySelector('[name="parking_lot"]').addEventListener('change', async function() {
    const lotId = this.value;
    const floorField = document.getElementById('floor-field');
    const areaField = document.getElementById('area-field');
    const floorSelect = document.getElementById('floor-select');
    const areaSelect = document.getElementById('area-select');
    
    if (!lotId) {
        floorField.classList.add('hidden');
        areaField.classList.add('hidden');
        return;
    }
    
    try {
        // 使用API获取停车场详细信息
        const response = await fetch(`/parking/api/lots/${lotId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success && result.data) {
                const lot = result.data;
                
                if (lot.floors && lot.floors.length > 0) {
                    // 显示楼层选择
                    floorField.classList.remove('hidden');
                    floorSelect.innerHTML = '<option value="">无（露天停车场）</option>';
                    lot.floors.forEach(floor => {
                        const option = document.createElement('option');
                        option.value = floor;
                        option.textContent = floor;
                        {% if space.floor %}
                        if (option.value === '{{ space.floor }}') {
                            option.selected = true;
                        }
                        {% endif %}
                        floorSelect.appendChild(option);
                    });
                    
                    // 显示区域选择
                    areaField.classList.remove('hidden');
                    const firstFloor = lot.floors[0];
                    {% if space.floor %}
                    const currentFloor = '{{ space.floor }}' || firstFloor;
                    {% else %}
                    const currentFloor = firstFloor;
                    {% endif %}
                    updateAreaOptions(lot.areas, currentFloor);
                    
                    // 楼层变化时更新区域选项
                    floorSelect.addEventListener('change', function() {
                        const selectedFloor = this.value;
                        updateAreaOptions(lot.areas, selectedFloor);
                    });
                } else {
                    floorField.classList.add('hidden');
                    areaField.classList.add('hidden');
                }
            }
        }
    } catch (error) {
        console.error('加载停车场信息失败:', error);
    }
});

function updateAreaOptions(areas, floor) {
    const areaSelect = document.getElementById('area-select');
    areaSelect.innerHTML = '<option value="">无</option>';
    
    if (areas && areas[floor] && areas[floor].length > 0) {
        areas[floor].forEach(area => {
            const option = document.createElement('option');
            option.value = area;
            option.textContent = area;
            {% if space.area %}
            if (option.value === '{{ space.area }}') {
                option.selected = true;
            }
            {% endif %}
            areaSelect.appendChild(option);
        });
    }
}

// 页面加载时如果有选中的停车场，自动加载
document.addEventListener('DOMContentLoaded', function() {
    const lotSelect = document.querySelector('[name="parking_lot"]');
    if (lotSelect.value) {
        lotSelect.dispatchEvent(new Event('change'));
    }
});

// 车位表单前端验证（提交前）
function validateParkingSpaceForm(event) {
    // ========== 前端验证（提交前） ==========
    
    // 1. 验证停车场（必填）
    const lotSelect = document.getElementById('parking-lot-select');
    if (!lotSelect || !lotSelect.value) {
        alert('请选择所属停车场');
        if (lotSelect) lotSelect.focus();
        event.preventDefault();
        return false;
    }
    
    // 2. 验证车位号（必填）
    const spaceNumberInput = document.getElementById('space-number-input');
    const spaceNumber = spaceNumberInput ? spaceNumberInput.value.trim() : '';
    if (!spaceNumber) {
        alert('请输入车位号');
        if (spaceNumberInput) spaceNumberInput.focus();
        event.preventDefault();
        return false;
    }
    
    // 3. 验证车位类型（必填）
    const spaceTypeSelect = document.getElementById('space-type-select');
    if (!spaceTypeSelect || !spaceTypeSelect.value) {
        alert('请选择车位类型');
        if (spaceTypeSelect) spaceTypeSelect.focus();
        event.preventDefault();
        return false;
    }
    
    // 所有验证通过，允许提交
    return true;
}
</script>
{% endblock %}

