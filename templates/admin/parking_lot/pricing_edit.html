{% extends 'admin/base.html' %}
{% load static %}

{% block title %}停车场费率配置{% endblock %}
{% block page_title %}停车场费率配置{% endblock %}

{% block breadcrumb %}
<nav class="flex items-center gap-2 text-sm text-slate-400 ml-4" aria-label="面包屑导航">
    <a href="{% url 'parking:admin_index' %}" class="hover:text-white" aria-label="返回首页">首页</a>
    <i class="fas fa-chevron-right text-xs" aria-hidden="true"></i>
    <a href="{% url 'parking:admin_parking_lot_list' %}" class="hover:text-white" aria-label="停车场管理">停车场管理</a>
    <i class="fas fa-chevron-right text-xs" aria-hidden="true"></i>
    <a href="{% url 'parking:admin_parking_lot_detail' parking_lot.id %}" class="hover:text-white" aria-label="停车场 {{ parking_lot.name }}">{{ parking_lot.name }}</a>
    <i class="fas fa-chevron-right text-xs" aria-hidden="true"></i>
    <span class="text-slate-200" aria-current="page">费率配置</span>
</nav>
{% endblock %}

{% block content %}
<div class="max-w-4xl">
     <form id="pricing-form" 
           class="space-y-6" 
           novalidate 
           data-validate
           data-lot-id="{{ parking_lot.id|default:0 }}"
           data-preview-url="{% url 'parking:api_pricing_preview' %}"
           data-save-url="{% url 'parking:admin_parking_lot_pricing' parking_lot.id %}"
           data-detail-url="{% url 'parking:admin_parking_lot_detail' parking_lot.id %}">
        {% csrf_token %}
        
        <!-- 收费类型选择 -->
        <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6 space-y-5" role="region" aria-labelledby="charge-type-title">
            <h3 id="charge-type-title" class="text-lg font-semibold text-white border-b border-slate-700/50 pb-4 mb-5">
                <i class="fas fa-cog text-primary-400 mr-2" aria-hidden="true"></i>
                收费类型
            </h3>
            
            <fieldset>
                <legend class="sr-only">选择收费类型</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" role="radiogroup" aria-labelledby="charge-type-legend">
                    <label class="relative cursor-pointer">
                        <input type="radio" 
                               name="charge_type" 
                               value="fixed" 
                               {% if pricing_config.charge_type == 'fixed' or not pricing_config.charge_type %}checked{% endif %}
                               class="peer sr-only" 
                               onchange="toggleChargeType()"
                               aria-describedby="fixed-desc">
                        <div class="p-6 bg-slate-900/50 border-2 border-slate-700 rounded-lg transition-all
                                    peer-checked:border-primary-500 peer-checked:bg-primary-500/10">
                            <div class="flex items-center gap-3 mb-2">
                                <i class="fas fa-clock text-2xl text-primary-400" aria-hidden="true"></i>
                                <h4 class="text-lg font-semibold text-white">固定费率</h4>
                            </div>
                            <p id="fixed-desc" class="text-sm text-slate-400">按小时固定收费，简单明了</p>
                        </div>
                    </label>
                    
                    <label class="relative cursor-pointer">
                        <input type="radio" 
                               name="charge_type" 
                               value="tiered" 
                               {% if pricing_config.charge_type == 'tiered' %}checked{% endif %}
                               class="peer sr-only" 
                               onchange="toggleChargeType()"
                               aria-describedby="tiered-desc">
                        <div class="p-6 bg-slate-900/50 border-2 border-slate-700 rounded-lg transition-all
                                    peer-checked:border-primary-500 peer-checked:bg-primary-500/10">
                            <div class="flex items-center gap-3 mb-2">
                                <i class="fas fa-layer-group text-2xl text-primary-400" aria-hidden="true"></i>
                                <h4 class="text-lg font-semibold text-white">阶梯收费</h4>
                            </div>
                            <p id="tiered-desc" class="text-sm text-slate-400">多时间段不同费率，灵活配置</p>
                        </div>
                    </label>
                </div>
            </fieldset>
        </div>
        
        <!-- 固定费率配置 -->
        <div id="fixed-pricing" 
             class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6 space-y-5" 
             style="display: {% if pricing_config.charge_type == 'tiered' %}none{% else %}block{% endif %};"
             role="region"
             aria-labelledby="fixed-pricing-title">
            <h3 id="fixed-pricing-title" class="text-lg font-semibold text-white border-b border-slate-700/50 pb-4 mb-5">
                <i class="fas fa-dollar-sign text-primary-400 mr-2" aria-hidden="true"></i>
                固定费率设置
            </h3>
            
            <div>
                <label for="hourly-rate-pricing" class="block text-sm font-medium text-slate-300 mb-2">
                    小时费率（元/小时） <span class="text-red-400" aria-label="必填">*</span>
                </label>
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" aria-hidden="true">¥</span>
                    <input type="number" 
                           id="hourly-rate-pricing" 
                           name="hourly_rate" 
                           value="{{ pricing_config.hourly_rate|default:parking_lot.hourly_rate|default:'5.00' }}" 
                           required 
                           min="0" 
                           step="0.01"
                           class="w-full pl-8 pr-16 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                           aria-describedby="hourly-rate-pricing-hint"
                           aria-required="true">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400" aria-hidden="true">/小时</span>
                </div>
                <p id="hourly-rate-pricing-hint" class="text-xs text-slate-500 mt-1 sr-only">输入小时费率（元/小时）</p>
            </div>
        </div>
        
        <!-- 阶梯收费配置 -->
        <div id="tiered-pricing" 
             class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6 space-y-5"
             style="display: {% if pricing_config.charge_type == 'tiered' %}block{% else %}none{% endif %};"
             role="region"
             aria-labelledby="tiered-pricing-title">
            <h3 id="tiered-pricing-title" class="text-lg font-semibold text-white border-b border-slate-700/50 pb-4 mb-5">
                <i class="fas fa-list-ol text-primary-400 mr-2" aria-hidden="true"></i>
                阶梯收费设置
            </h3>
            
            <!-- 模板选择 -->
            <div>
                <label for="template-select-pricing" class="block text-sm font-medium text-slate-300 mb-2">
                    选择费率模板
                </label>
                <select id="template-select-pricing" 
                        name="template_id" 
                        onchange="loadTemplate()"
                        class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                        aria-describedby="template-select-hint">
                    <option value="">不使用模板（自定义）</option>
                    {% for template in templates %}
                    <option value="{{ template.id }}" 
                            {% if pricing_config.template_id == template.id %}selected{% endif %}>
                        {{ template.name }} (免费{{ template.free_minutes }}分钟)
                    </option>
                    {% endfor %}
                </select>
                <p id="template-select-hint" class="mt-2 text-xs text-slate-500">
                    <a href="{% url 'parking:admin_pricing_template_list' %}" 
                       class="text-primary-400 hover:text-primary-300"
                       aria-label="管理费率模板">
                        <i class="fas fa-external-link-alt mr-1" aria-hidden="true"></i>管理费率模板
                    </a>
                </p>
            </div>
            
            <!-- 自定义配置 -->
            <div id="custom-config" class="space-y-4" role="region" aria-labelledby="custom-config-title">
                <h4 id="custom-config-title" class="sr-only">自定义配置</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="free-minutes-pricing" class="block text-sm font-medium text-slate-300 mb-2">
                            免费时长（分钟）
                        </label>
                        <input type="number" 
                               id="free-minutes-pricing" 
                               name="free_minutes" 
                               value="{{ pricing_config.free_minutes|default:15 }}" 
                               min="0"
                               class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                               aria-describedby="free-minutes-pricing-hint">
                        <p id="free-minutes-pricing-hint" class="text-xs text-slate-500 mt-1 sr-only">设置免费停车时长（分钟）</p>
                    </div>
                    
                    <div>
                        <label for="daily-max-fee-pricing" class="block text-sm font-medium text-slate-300 mb-2">
                            每日收费上限（元）
                        </label>
                        <input type="number" 
                               id="daily-max-fee-pricing" 
                               name="daily_max_fee" 
                               value="{{ pricing_config.daily_max_fee|default:'' }}" 
                               min="0" 
                               step="0.01"
                               placeholder="留空表示不设上限"
                               class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                               aria-describedby="daily-max-fee-pricing-hint">
                        <p id="daily-max-fee-pricing-hint" class="text-xs text-slate-500 mt-1">设置每日收费上限，留空表示不设上限</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 费率预览 -->
        <div id="pricing-preview" 
             class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6 space-y-5"
             role="region"
             aria-labelledby="preview-title">
            <h3 id="preview-title" class="text-lg font-semibold text-white border-b border-slate-700/50 pb-4 mb-5">
                <i class="fas fa-calculator text-primary-400 mr-2" aria-hidden="true"></i>
                费率预览
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="preview-duration" class="block text-sm font-medium text-slate-300 mb-2">
                        停车时长（分钟）
                    </label>
                    <input type="number" 
                           id="preview-duration" 
                           value="60" 
                           min="0" 
                           step="1"
                           oninput="calculatePreview()"
                           class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                           aria-describedby="preview-duration-hint"
                           aria-label="输入停车时长（分钟）">
                    <p id="preview-duration-hint" class="text-xs text-slate-500 mt-1 sr-only">输入停车时长以预览费用</p>
                </div>
                <div>
                    <label for="preview-fee" class="block text-sm font-medium text-slate-300 mb-2">
                        预计费用
                    </label>
                    <div class="px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg" role="status" aria-live="polite">
                        <span id="preview-fee" class="text-2xl font-bold text-primary-400">¥0.00</span>
                    </div>
                </div>
            </div>
            
            <div id="preview-details" class="hidden space-y-2" role="region" aria-labelledby="preview-details-title">
                <h4 id="preview-details-title" class="text-sm font-medium text-slate-300">费用明细：</h4>
                <div id="preview-breakdown" class="text-sm text-slate-400 space-y-1" role="list" aria-label="费用明细"></div>
            </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="flex items-center gap-4" role="group" aria-label="表单操作">
            <button type="submit" 
                    class="btn-ripple px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors"
                    aria-label="保存费率配置">
                <i class="fas fa-save mr-2" aria-hidden="true"></i>保存配置
            </button>
            <a href="{% url 'parking:admin_parking_lot_detail' parking_lot.id %}" 
               class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors"
               aria-label="取消并返回停车场详情">
                取消
            </a>
        </div>
    </form>
</div>


<script src="{% static 'admin/parking_lot/pricing_edit/js/script.js' %}"></script>
{% endblock %}

