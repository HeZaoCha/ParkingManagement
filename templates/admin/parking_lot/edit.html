{% extends 'admin/base.html' %}

{% block title %}{% if lot %}编辑停车场{% else %}新增停车场{% endif %}{% endblock %}
{% block page_title %}{% if lot %}编辑停车场{% else %}新增停车场{% endif %}{% endblock %}

{% block breadcrumb %}
<nav class="flex items-center gap-2 text-sm text-slate-400 ml-4" aria-label="面包屑导航">
    <a href="{% url 'parking:admin_index' %}" class="hover:text-white" aria-label="返回首页">首页</a>
    <i class="fas fa-chevron-right text-xs" aria-hidden="true"></i>
    <a href="{% url 'parking:admin_parking_lot_list' %}" class="hover:text-white" aria-label="停车场管理">停车场管理</a>
    <i class="fas fa-chevron-right text-xs" aria-hidden="true"></i>
    <span class="text-slate-200" aria-current="page">{% if lot %}编辑{% else %}新增{% endif %}</span>
</nav>
{% endblock %}

{% block content %}
<div class="max-w-2xl">
    <form method="post" class="space-y-6" novalidate data-validate>
        {% csrf_token %}
        
        <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6 space-y-5" role="region" aria-labelledby="basic-info-title">
            <h3 id="basic-info-title" class="text-lg font-semibold text-white border-b border-slate-700/50 pb-4 mb-5">
                <i class="fas fa-warehouse text-primary-400 mr-2" aria-hidden="true"></i>
                基本信息
            </h3>
            
            <!-- 名称 -->
            <div>
                <label for="name-input" class="block text-sm font-medium text-slate-300 mb-2">
                    停车场名称 <span class="text-red-400" aria-label="必填">*</span>
                </label>
                <input type="text" 
                       id="name-input"
                       name="name" 
                       value="{{ lot.name|default:'' }}" 
                       required
                       data-validation="text_length"
                       data-max-length="100"
                       placeholder="请输入停车场名称"
                       class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors"
                       aria-describedby="name-hint name-input-error"
                       aria-required="true">
                <div id="name-input-error" class="text-xs text-red-500 mt-1 hidden" role="alert" aria-live="polite"></div>
                <p id="name-hint" class="mt-1 text-xs text-slate-500 sr-only">请输入停车场名称</p>
            </div>
            
            <!-- 地址 -->
            <div>
                <label for="address-input" class="block text-sm font-medium text-slate-300 mb-2">
                    地址
                </label>
                <input type="text" 
                       id="address-input"
                       name="address" 
                       value="{{ lot.address|default:'' }}"
                       placeholder="请输入停车场地址"
                       class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors"
                       aria-describedby="address-hint">
                <p id="address-hint" class="mt-1 text-xs text-slate-500 sr-only">请输入停车场地址</p>
            </div>
            
            <!-- 总车位数 -->
            <div>
                <label for="total-spaces-input" class="block text-sm font-medium text-slate-300 mb-2">
                    总车位数 <span class="text-red-400" aria-label="必填">*</span>
                </label>
                <input type="number" 
                       id="total-spaces-input"
                       name="total_spaces" 
                       value="{{ lot.total_spaces|default:0 }}" 
                       required 
                       data-validation="positive_integer"
                       min="0"
                       placeholder="请输入总车位数"
                       class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors"
                       aria-describedby="total-spaces-hint total-spaces-input-error"
                       aria-required="true">
                <div id="total-spaces-input-error" class="text-xs text-red-500 mt-1 hidden" role="alert" aria-live="polite"></div>
                <p id="total-spaces-hint" class="mt-1 text-xs text-slate-500">设置停车场规划的总车位数量</p>
            </div>
            
            <!-- 小时费率 -->
            <div>
                <label for="hourly-rate-input" class="block text-sm font-medium text-slate-300 mb-2">
                    小时费率 <span class="text-red-400" aria-label="必填">*</span>
                </label>
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" aria-hidden="true">¥</span>
                    <input type="number" 
                           id="hourly-rate-input"
                           name="hourly_rate" 
                           value="{{ lot.hourly_rate|default:'5.00' }}" 
                           required 
                           data-validation="non_negative"
                           min="0" 
                           step="0.01"
                           class="w-full pl-8 pr-16 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500 transition-colors"
                           aria-describedby="hourly-rate-hint hourly-rate-input-error"
                           aria-required="true">
                <div id="hourly-rate-input-error" class="text-xs text-red-500 mt-1 hidden" role="alert" aria-live="polite"></div>
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400" aria-hidden="true">/小时</span>
                </div>
                <p id="hourly-rate-hint" class="mt-1 text-xs text-slate-500 sr-only">请输入小时费率</p>
            </div>
            
            <!-- 停车场类型 -->
            <div>
                <label for="lot-type" class="block text-sm font-medium text-slate-300 mb-2">
                    停车场类型
                </label>
                <select name="lot_type" 
                        id="lot-type"
                        class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                        onchange="handleLotTypeChange()"
                        aria-describedby="lot-type-hint">
                    <option value="outdoor" {% if lot.lot_type == 'outdoor' or not lot %}selected{% endif %}>露天停车场</option>
                    <option value="multi_story" {% if lot.lot_type == 'multi_story' %}selected{% endif %}>立体停车楼</option>
                    <option value="street" {% if lot.lot_type == 'street' %}selected{% endif %}>街道停车场</option>
                    <option value="underground" {% if lot.lot_type == 'underground' %}selected{% endif %}>地下停车场</option>
                </select>
                <p id="lot-type-hint" class="mt-1 text-xs text-slate-500">选择停车场类型，影响楼层和区域管理</p>
            </div>
            
            <!-- 楼层管理 -->
            <div id="floors-section" class="{% if lot.lot_type == 'outdoor' or not lot %}hidden{% endif %}" role="region" aria-labelledby="floors-title">
                <label id="floors-title" class="block text-sm font-medium text-slate-300 mb-2">
                    <i class="fas fa-building mr-1" aria-hidden="true"></i>楼层管理
                </label>
                <div class="space-y-3">
                    <div id="floors-list" class="space-y-2" role="list" aria-label="楼层列表">
                        <!-- 楼层列表将通过JavaScript动态生成 -->
                    </div>
                    <button type="button" 
                            onclick="addFloor()" 
                            class="w-full px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors text-sm"
                            aria-label="添加新楼层">
                        <i class="fas fa-plus mr-1" aria-hidden="true"></i>添加楼层
                    </button>
                </div>
                <input type="hidden" name="floors" id="floors-input" value='{% if lot.floors %}{{ lot.floors|safe }}{% else %}[]{% endif %}'>
                <p class="mt-1 text-xs text-slate-500">例如：B2, B3, 1F, 2F（露天停车场无需设置）</p>
            </div>
            
            <!-- 区域管理 -->
            <div id="areas-section" class="{% if lot.lot_type == 'outdoor' or not lot %}hidden{% endif %}" role="region" aria-labelledby="areas-title">
                <label id="areas-title" class="block text-sm font-medium text-slate-300 mb-2">
                    <i class="fas fa-map-marked-alt mr-1" aria-hidden="true"></i>区域管理
                </label>
                <div class="space-y-3">
                    <div id="areas-list" class="space-y-3" role="list" aria-label="区域列表">
                        <!-- 区域列表将通过JavaScript动态生成 -->
                    </div>
                    <p class="text-xs text-slate-400">为每个楼层设置区域，如：A区、B区、C区</p>
                </div>
                <input type="hidden" name="areas" id="areas-input" value='{% if lot.areas %}{{ lot.areas|safe }}{% else %}{}{% endif %}'>
            </div>
            
            <!-- 状态 -->
            <div>
                <label for="is-active-checkbox" class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox" 
                           id="is-active-checkbox"
                           name="is_active" 
                           {% if lot.is_active or not lot %}checked{% endif %}
                           class="w-5 h-5 rounded border-slate-600 bg-slate-900 text-primary-600 focus:ring-primary-500 focus:ring-offset-0"
                           aria-describedby="is-active-hint">
                    <span class="text-slate-300">启用停车场</span>
                </label>
                <p id="is-active-hint" class="mt-1 text-xs text-slate-500 ml-8">禁用后该停车场将不再接受新车入场</p>
            </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="flex items-center gap-4" role="group" aria-label="表单操作">
            <button type="submit" 
                    class="btn-ripple inline-flex items-center gap-2 px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors"
                    aria-label="保存停车场信息">
                <i class="fas fa-save" aria-hidden="true"></i>
                保存
            </button>
            <a href="{% url 'parking:admin_parking_lot_list' %}" 
               class="px-6 py-3 text-slate-400 hover:text-white transition-colors"
               aria-label="取消并返回停车场列表">
                取消
            </a>
        </div>
    </form>
</div>

<script>
// 停车场类型数据
let floors = {% if lot.floors %}{{ lot.floors|safe }}{% else %}[]{% endif %};
let areas = {% if lot.areas %}{{ lot.areas|safe }}{% else %}{}{% endif %};

// 处理停车场类型变化
function handleLotTypeChange() {
    const lotType = document.getElementById('lot-type').value;
    const floorsSection = document.getElementById('floors-section');
    const areasSection = document.getElementById('areas-section');
    
    if (lotType === 'outdoor') {
        floorsSection.classList.add('hidden');
        areasSection.classList.add('hidden');
        floors = [];
        areas = {};
    } else {
        floorsSection.classList.remove('hidden');
        areasSection.classList.remove('hidden');
        if (floors.length === 0) {
            floors = ['1F'];
        }
        renderFloors();
        renderAreas();
    }
    updateHiddenInputs();
}

// 添加楼层
function addFloor() {
    const floorName = prompt('请输入楼层名称（如：B2, 1F, 2F）:');
    if (floorName && floorName.trim()) {
        const floor = floorName.trim();
        if (!floors.includes(floor)) {
            floors.push(floor);
            if (!areas[floor]) {
                areas[floor] = [];
            }
            renderFloors();
            renderAreas();
            updateHiddenInputs();
        } else {
            alert('该楼层已存在');
        }
    }
}

// 删除楼层
function removeFloor(floor) {
    if (confirm(`确定要删除楼层 "${floor}" 吗？这将同时删除该楼层的所有区域。`)) {
        floors = floors.filter(f => f !== floor);
        delete areas[floor];
        renderFloors();
        renderAreas();
        updateHiddenInputs();
    }
}

// 渲染楼层列表
function renderFloors() {
    const container = document.getElementById('floors-list');
    container.innerHTML = '';
    
    floors.forEach(floor => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2 p-2 bg-slate-900/50 rounded-lg';
        div.innerHTML = `
            <span class="flex-1 text-white font-mono">${floor}</span>
            <button type="button" onclick="removeFloor('${floor}')" 
                    class="px-2 py-1 text-red-400 hover:text-red-300 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(div);
    });
}

// 添加区域
function addArea(floor) {
    const areaName = prompt(`为楼层 "${floor}" 添加区域（如：A区、B区）:`);
    if (areaName && areaName.trim()) {
        const area = areaName.trim();
        if (!areas[floor].includes(area)) {
            areas[floor].push(area);
            renderAreas();
            updateHiddenInputs();
        } else {
            alert('该区域已存在');
        }
    }
}

// 删除区域
function removeArea(floor, area) {
    areas[floor] = areas[floor].filter(a => a !== area);
    renderAreas();
    updateHiddenInputs();
}

// 渲染区域列表
function renderAreas() {
    const container = document.getElementById('areas-list');
    container.innerHTML = '';
    
    floors.forEach(floor => {
        if (!areas[floor]) {
            areas[floor] = [];
        }
        
        const div = document.createElement('div');
        div.className = 'p-3 bg-slate-900/50 rounded-lg';
        div.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-slate-300">${floor}</span>
                <button type="button" onclick="addArea('${floor}')" 
                        class="px-2 py-1 text-xs bg-primary-600 hover:bg-primary-700 text-white rounded transition-colors">
                    <i class="fas fa-plus mr-1"></i>添加区域
                </button>
            </div>
            <div class="flex flex-wrap gap-2" id="areas-${floor}">
                ${areas[floor].map(area => `
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-slate-700 text-slate-300 rounded text-sm">
                        ${area}
                        <button type="button" onclick="removeArea('${floor}', '${area}')" 
                                class="text-red-400 hover:text-red-300">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </span>
                `).join('')}
                ${areas[floor].length === 0 ? '<span class="text-xs text-slate-500">暂无区域</span>' : ''}
            </div>
        `;
        container.appendChild(div);
    });
}

// 更新隐藏输入
function updateHiddenInputs() {
    document.getElementById('floors-input').value = JSON.stringify(floors);
    document.getElementById('areas-input').value = JSON.stringify(areas);
}

// 表单提交前验证和更新
document.querySelector('form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // ========== 前端验证（提交前） ==========
    let hasError = false;
    
    // 1. 验证停车场名称（必填）
    const nameInput = document.getElementById('name-input');
    const name = nameInput.value.trim();
    if (!name) {
        alert('请输入停车场名称');
        nameInput.focus();
        return;
    }
    if (name.length > 100) {
        alert('停车场名称长度不能超过100个字符');
        nameInput.focus();
        return;
    }
    
    // 2. 验证总车位数（必填，正整数）
    const totalSpacesInput = document.getElementById('total-spaces-input');
    const totalSpaces = parseInt(totalSpacesInput.value);
    if (!totalSpacesInput.value || isNaN(totalSpaces) || totalSpaces <= 0) {
        alert('请输入有效的总车位数（正整数）');
        totalSpacesInput.focus();
        return;
    }
    
    // 3. 验证小时费率（必填，非负数）
    const hourlyRateInput = document.getElementById('hourly-rate-input');
    const hourlyRate = parseFloat(hourlyRateInput.value);
    if (!hourlyRateInput.value || isNaN(hourlyRate) || hourlyRate < 0) {
        alert('请输入有效的小时费率（非负数）');
        hourlyRateInput.focus();
        return;
    }
    
    // 4. 验证楼层和区域数据
    if (floors.length === 0) {
        alert('请至少添加一个楼层');
        return;
    }
    
    // 所有验证通过，更新隐藏字段并提交
    updateHiddenInputs();
    
    // 使用FormData提交（保持原有提交方式）
    const form = e.target;
    const formData = new FormData(form);
    
    fetch(form.action || window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json().catch(() => ({ success: true }));
        }
        return response.json().then(data => ({ success: false, message: data.message || '保存失败' }));
    })
    .then(result => {
        if (result.success) {
            alert('保存成功');
            window.location.href = result.redirect_url || '{% url "parking:admin_parking_lot_list" %}';
        } else {
            alert('保存失败：' + (result.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('提交失败:', error);
        alert('保存失败，请稍后重试');
    });
});

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    if (floors.length > 0) {
        renderFloors();
    }
    if (Object.keys(areas).length > 0) {
        renderAreas();
    }
});
</script>
{% endblock %}

