{% extends 'admin/base.html' %}
{% load static %}

{% block title %}公安查询{% endblock %}
{% block page_title %}公安查询 - 车辆停车记录查询{% endblock %}

{% block breadcrumb %}
<nav class="flex items-center gap-2 text-sm text-slate-400 ml-4" aria-label="面包屑导航">
    <a href="{% url 'parking:admin_index' %}" class="hover:text-white" aria-label="返回首页">首页</a>
    <i class="fas fa-chevron-right text-xs" aria-hidden="true"></i>
    <span class="text-slate-200" aria-current="page">公安查询</span>
</nav>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- 查询表单 -->
    <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-6" role="region" aria-labelledby="query-form-title">
        <h3 id="query-form-title" class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <i class="fas fa-search text-primary-400" aria-hidden="true"></i>
            查询条件
        </h3>
        <form method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" role="search" aria-label="公安查询" novalidate data-validate data-api-police-query-url="{% url 'parking:api_police_query' %}">
            <!-- 省份 -->
            <div>
                <label for="province-select" class="block text-sm font-medium text-slate-300 mb-2">省份</label>
                <select id="province-select"
                        name="province" 
                        class="w-full px-4 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500"
                        aria-label="选择省份">
                    <option value="">全部省份</option>
                    {% for prov_code, prov_name in provinces %}
                    <option value="{{ prov_code }}" {% if province_code == prov_code %}selected{% endif %}>{{ prov_code }} - {{ prov_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- 地级市 -->
            <div>
                <label for="city-input" class="block text-sm font-medium text-slate-300 mb-2">地级市</label>
                <input type="text" 
                       id="city-input"
                       name="city" 
                       value="{{ city_code }}" 
                       placeholder="如：E"
                       data-validation="text_length"
                       data-max-length="1"
                       class="w-full px-4 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white uppercase focus:outline-none focus:border-primary-500"
                       maxlength="1"
                       aria-label="输入地级市代码"
                       aria-describedby="city-hint city-input-error">
                <p id="city-hint" class="text-xs text-slate-500 mt-1 sr-only">输入地级市代码，如：E</p>
                <div id="city-input-error" class="text-xs text-red-500 mt-1 hidden" role="alert" aria-live="polite"></div>
            </div>
            
            <!-- 车牌号 -->
            <div>
                <label for="police-license-plate" class="block text-sm font-medium text-slate-300 mb-2">车牌号</label>
                <input type="hidden" 
                       id="police-license-plate" 
                       name="license_plate" 
                       value="{{ license_plate }}" 
                       data-plate-field="true"
                       aria-describedby="plate-hint">
                <div class="plate-grid" data-plate-grid-for="police-license-plate" aria-label="车牌号输入"></div>
                <p id="plate-hint" class="text-xs text-slate-500 mt-1">支持模糊搜索，留空为全部</p>
            </div>
            
            <!-- 日期范围 -->
            <div>
                <label for="date-from-police" class="block text-sm font-medium text-slate-300 mb-2">日期范围</label>
                <div class="flex gap-2">
                    <label for="date-from-police" class="sr-only">开始日期</label>
                    <input type="date" 
                           id="date-from-police"
                           name="date_from" 
                           value="{{ date_from }}" 
                           class="flex-1 px-4 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500"
                           aria-label="开始日期">
                    <label for="date-to-police" class="sr-only">结束日期</label>
                    <input type="date" 
                           id="date-to-police"
                           name="date_to" 
                           value="{{ date_to }}" 
                           class="flex-1 px-4 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-primary-500"
                           aria-label="结束日期">
                </div>
            </div>
            
            <div class="md:col-span-2 lg:col-span-4 flex gap-3" role="group" aria-label="操作按钮">
                <button type="submit" 
                        class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors flex items-center gap-2"
                        aria-label="执行查询">
                    <i class="fas fa-search" aria-hidden="true"></i>
                    查询
                </button>
                <a href="{% url 'parking:admin_police_query' %}" 
                   class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors flex items-center gap-2"
                   aria-label="重置查询条件">
                    <i class="fas fa-redo" aria-hidden="true"></i>
                    重置
                </a>
                <button type="button" 
                        onclick="exportData()" 
                        class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors flex items-center gap-2"
                        aria-label="导出查询结果">
                    <i class="fas fa-download" aria-hidden="true"></i>
                    导出数据
                </button>
            </div>
        </form>
    </div>
    
    <!-- 统计信息 -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4" aria-label="查询统计" role="region">
        <article class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-5" role="article" aria-labelledby="total-count-label">
            <div class="flex items-center justify-between">
                <div>
                    <p id="total-count-label" class="text-slate-400 text-sm">查询结果</p>
                    <p class="text-2xl font-bold text-white mt-1" aria-live="polite">{{ stats.total_count }}</p>
                </div>
                <i class="fas fa-list text-3xl text-primary-400 opacity-50" aria-hidden="true"></i>
            </div>
        </article>
        <article class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-5" role="article" aria-labelledby="unique-vehicles-label">
            <div class="flex items-center justify-between">
                <div>
                    <p id="unique-vehicles-label" class="text-slate-400 text-sm">不同车辆</p>
                    <p class="text-2xl font-bold text-white mt-1" aria-live="polite">{{ stats.unique_vehicles }}</p>
                </div>
                <i class="fas fa-car text-3xl text-blue-400 opacity-50" aria-hidden="true"></i>
            </div>
        </article>
        <article class="bg-slate-800/50 border border-slate-700/50 rounded-xl p-5" role="article" aria-labelledby="total-revenue-police-label">
            <div class="flex items-center justify-between">
                <div>
                    <p id="total-revenue-police-label" class="text-slate-400 text-sm">总收入</p>
                    <p class="text-2xl font-bold text-emerald-400 mt-1" aria-live="polite">¥{{ stats.total_revenue }}</p>
                </div>
                <i class="fas fa-dollar-sign text-3xl text-emerald-400 opacity-50" aria-hidden="true"></i>
            </div>
        </article>
    </section>
    
    <!-- 查询结果 -->
    <div class="bg-slate-800/50 border border-slate-700/50 rounded-xl overflow-hidden" role="region" aria-labelledby="query-results-title">
        <div class="p-5 border-b border-slate-700/50">
            <h3 id="query-results-title" class="text-lg font-semibold text-white flex items-center gap-2">
                <i class="fas fa-table text-slate-400" aria-hidden="true"></i>
                查询结果
            </h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full" role="table" aria-label="查询结果列表">
                <thead>
                    <tr class="text-left text-sm text-slate-400 bg-slate-800/50">
                        <th scope="col" class="px-5 py-3 font-medium">车牌号</th>
                        <th scope="col" class="px-5 py-3 font-medium">所属地区</th>
                        <th scope="col" class="px-5 py-3 font-medium">停车场</th>
                        <th scope="col" class="px-5 py-3 font-medium">区域/楼层</th>
                        <th scope="col" class="px-5 py-3 font-medium">车位号</th>
                        <th scope="col" class="px-5 py-3 font-medium">入场时间</th>
                        <th scope="col" class="px-5 py-3 font-medium">离场时间</th>
                        <th scope="col" class="px-5 py-3 font-medium">停车时长</th>
                        <th scope="col" class="px-5 py-3 font-medium">费用</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-700/50">
                    {% for record in records %}
                    <tr class="table-row-hover">
                        <td class="px-5 py-4">
                            <span class="font-mono font-medium text-white">{{ record.vehicle.license_plate }}</span>
                        </td>
                        <td class="px-5 py-4 text-slate-300">
                            {% if record.plate_province_name %}
                            {{ record.plate_province_name }}{{ record.plate_city_name }}
                            {% else %}
                            {{ record.plate_province_code }}{{ record.plate_city_code }}
                            {% endif %}
                        </td>
                        <td class="px-5 py-4 text-slate-300">{{ record.parking_space.parking_lot.name }}</td>
                        <td class="px-5 py-4 text-slate-300">
                            {% if record.parking_space.floor or record.parking_space.area %}
                            {{ record.parking_space.floor|default:'' }}{{ record.parking_space.area|default:'' }}
                            {% else %}
                            <span class="text-slate-500">-</span>
                            {% endif %}
                        </td>
                        <td class="px-5 py-4 text-slate-300">{{ record.parking_space.space_number }}</td>
                        <td class="px-5 py-4 text-slate-400 text-sm">
                            {{ record.entry_time|date:"Y-m-d H:i:s" }}
                        </td>
                        <td class="px-5 py-4 text-slate-400 text-sm">
                            {% if record.exit_time %}
                            {{ record.exit_time|date:"Y-m-d H:i:s" }}
                            {% else %}
                            <span class="text-slate-500">-</span>
                            {% endif %}
                        </td>
                        <td class="px-5 py-4 text-slate-300">
                            {% if record.duration_minutes %}
                                {{ record.duration_minutes }} 分钟
                            {% else %}
                                <span class="text-slate-500">-</span>
                            {% endif %}
                        </td>
                        <td class="px-5 py-4">
                            {% if record.fee %}
                            <span class="text-emerald-400 font-medium">¥{{ record.fee }}</span>
                            {% else %}
                            <span class="text-slate-500">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="px-5 py-12 text-center text-slate-400" role="status" aria-live="polite">
                            <i class="fas fa-search text-4xl mb-3 opacity-50" aria-hidden="true"></i>
                            <p>暂无查询结果</p>
                            <p class="text-sm mt-2">请调整查询条件后重试</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- 分页 -->
        {% if records.has_other_pages %}
        <nav class="p-5 border-t border-slate-700/50 flex items-center justify-between" role="navigation" aria-label="分页导航">
            <div class="text-sm text-slate-400" aria-live="polite">
                显示第 {{ records.start_index }} - {{ records.end_index }} 条，共 {{ records.paginator.count }} 条
            </div>
            <div class="flex gap-2" role="group" aria-label="分页控件">
                {% if records.has_previous %}
                <a href="?page={{ records.previous_page_number }}{% if province_code %}&province={{ province_code }}{% endif %}{% if city_code %}&city={{ city_code }}{% endif %}{% if license_plate %}&license_plate={{ license_plate }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                   class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors"
                   aria-label="上一页">
                    上一页
                </a>
                {% endif %}
                {% if records.has_next %}
                <a href="?page={{ records.next_page_number }}{% if province_code %}&province={{ province_code }}{% endif %}{% if city_code %}&city={{ city_code }}{% endif %}{% if license_plate %}&license_plate={{ license_plate }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                   class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors"
                   aria-label="下一页">
                    下一页
                </a>
                {% endif %}
            </div>
        </nav>
        {% endif %}
    </div>
</div>


<script src="{% static 'admin/police/query/js/script.js' %}"></script>
{% endblock %}

