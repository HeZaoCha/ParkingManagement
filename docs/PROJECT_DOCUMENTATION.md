# 停车场管理系统 - 项目详细说明文档

**版本**: v1.1.0  
**最后更新**: 2025-12-12  
**作者**: HeZaoCha

---

## 目录

1. [系统概述](#系统概述)
2. [用户角色与权限](#用户角色与权限)
3. [核心模块功能](#核心模块功能)
4. [扩展模块功能](#扩展模块功能)
5. [不同角色的使用差异](#不同角色的使用差异)
6. [功能使用指南](#功能使用指南)

---

## 系统概述

早点喝茶停车场管理系统是一套基于 Django 5.2 和 Python 3.13 的现代化停车场运营解决方案，支持多角色权限管理、实时车位监控、智能费用计算等功能。

### 核心特性

- 🚗 **车辆管理**: 入场/出场登记、车牌号验证（GA 36-2018标准）
- 💰 **费用计算**: 支持固定收费和阶梯制收费，自动计算停车费用
- 📊 **实时监控**: 车位状态实时更新，数据统计仪表盘
- 🎫 **VIP/员工**: 支持免费停车和折扣停车
- 👥 **多角色**: 管理员、工作人员、客户三种角色，权限隔离
- 🎨 **现代化UI**: 响应式设计，支持11种主题色和亮暗模式切换
- 📈 **数据分析**: 停车记录查询、收入统计、报表生成

---

## 用户角色与权限

### 1. 管理员 (Admin)

**权限范围**:
- ✅ 完全系统权限
- ✅ 管理所有用户账号
- ✅ 配置停车场信息（名称、地址、费率、类型、楼层、区域）
- ✅ 管理停车位（创建、编辑、删除、批量创建）
- ✅ 管理车辆信息
- ✅ 查看所有停车记录
- ✅ 配置费率模板和阶梯收费规则
- ✅ 管理通缉车辆和警报日志
- ✅ 查看公安查询功能
- ✅ 管理排班表
- ✅ 查看联系消息并回复
- ✅ 查看系统审计日志

**访问入口**:
- 登录页面: `/login/`
- 管理后台: `/manage/`
- 工作台: `/dashboard/`（也可访问）

**主要功能模块**:
1. **数据概览** (`/manage/`)
   - 系统整体统计
   - 停车场使用情况
   - 今日收入统计

2. **停车场管理** (`/manage/lots/`)
   - 创建/编辑/删除停车场
   - 配置停车场类型（露天、立体、街道、地下）
   - 管理楼层和区域
   - 配置费率（固定/阶梯）

3. **车位管理** (`/manage/spaces/`)
   - 创建/编辑/删除车位
   - 批量创建车位（简单创建、范围创建、文件上传）
   - 查看车位状态

4. **车辆管理** (`/manage/vehicles/`)
   - 查看所有车辆信息
   - 管理VIP车辆

5. **停车记录** (`/manage/records/`)
   - 查看所有停车记录
   - 按条件筛选查询
   - 导出记录数据

6. **费率管理** (`/manage/pricing/`)
   - 创建/编辑费率模板
   - 配置阶梯收费规则
   - 应用模板到停车场
   - 费率预览功能

7. **安全功能**
   - 公安查询 (`/manage/police/`)
   - 通缉车辆管理 (`/manage/alerts/`)
   - 警报日志查看

8. **排班管理** (`/manage/schedules/`)
   - Excel模板下载
   - 排班表上传
   - 排班表可视化（表格/周视图/统计视图）

9. **联系管理** (`/manage/contacts/`)
   - 查看用户反馈
   - 回复联系消息

---

### 2. 工作人员 (Staff)

**权限范围**:
- ✅ 车辆入场登记
- ✅ 车辆出场结算
- ✅ 查询车辆状态
- ✅ 查看当日统计
- ✅ 查看工作台数据
- ❌ 无法访问管理后台
- ❌ 无法修改系统配置
- ❌ 无法查看所有历史记录

**访问入口**:
- 登录页面: `/login/`
- 工作台: `/dashboard/`（主要工作界面）

**主要功能模块**:
1. **工作台** (`/dashboard/`)
   - 实时车位状态
   - 今日统计（入场数、在场数、收入）
   - 最近停车记录
   - 快捷操作入口

2. **快捷操作**
   - **车辆入场**: 点击导航栏或快捷操作区的"车辆入场"按钮
     - 输入车牌号（智能车牌输入组件）
     - 选择停车场
     - 选择停车位（必选）
     - 选择车辆类型
     - 确认入场
   
   - **车辆出场**: 点击"车辆出场"按钮
     - 输入车牌号
     - 系统自动查询并显示停车信息
     - 显示停车时长和费用
     - 确认结算出场
   
   - **车辆查询**: 点击"查询车辆"按钮
     - 输入车牌号
     - 查看车辆当前状态
     - 查看停车费用（如果在场）

3. **数据查看**
   - 查看停车场实时状态
   - 查看车位使用情况
   - 查看今日收入

**界面特点**:
- 简洁的工作界面
- 快捷操作按钮突出显示
- 实时数据更新
- 操作反馈及时

---

### 3. 客户 (Customer)

**权限范围**:
- ✅ 自助查询停车状态
- ✅ 查看当前停车费用
- ✅ 查看停车场实时状态
- ✅ 提交联系反馈
- ❌ 无法进行入场/出场操作
- ❌ 无法查看其他车辆信息
- ❌ 无法访问管理功能

**访问入口**:
- 客户自助页面: `/parking/customer/`
- 无需登录即可使用基础查询功能

**主要功能模块**:
1. **停车查询** (`/parking/customer/`)
   - 输入车牌号查询
   - 查看车辆是否在场
   - 查看当前停车费用
   - 查看停车时长
   - 查看停车场和车位信息

2. **停车场状态**
   - 查看空闲车位数
   - 查看已停车辆数
   - 查看总车位数
   - 查看停车费率

3. **联系功能** (`/parking/contact/`)
   - 提交反馈表单
   - 查看在岗工作人员
   - 查看管理员联系方式

**界面特点**:
- 简洁明了的查询界面
- 友好的提示信息
- 清晰的状态展示
- 无需登录即可使用

---

## 核心模块功能

### parking - 停车场管理核心模块

#### 1. 数据模型 (models.py)

**ParkingLot（停车场）**
- **字段**:
  - `name`: 停车场名称
  - `address`: 地址
  - `total_spaces`: 总车位数（自动计算）
  - `hourly_rate`: 每小时费率
  - `is_active`: 是否启用
  - `lot_type`: 停车场类型（露天、立体、街道、地下）
  - `floors`: 楼层列表（JSON格式）
  - `areas`: 区域列表（JSON格式，按楼层组织）
- **属性方法**:
  - `available_spaces`: 可用车位数
  - `occupied_spaces`: 已占用车位数
- **使用场景**: 管理员配置停车场信息

**ParkingSpace（停车位）**
- **字段**:
  - `parking_lot`: 所属停车场（外键）
  - `space_number`: 车位号（唯一）
  - `space_type`: 车位类型（标准、VIP、大型、残疾人）
  - `floor`: 所在楼层
  - `area`: 所在区域
  - `is_occupied`: 是否占用
  - `is_reserved`: 是否预留
- **使用场景**: 管理员管理车位，工作人员分配车位

**Vehicle（车辆）**
- **字段**:
  - `license_plate`: 车牌号（唯一，符合GA 36-2018标准）
  - `vehicle_type`: 车辆类型（轿车、SUV、货车、摩托车、新能源车）
  - `owner_name`: 车主姓名
  - `owner_phone`: 车主电话
- **方法**:
  - `is_vip()`: 检查是否为VIP车辆
  - `get_vip_info()`: 获取VIP信息
- **使用场景**: 系统自动创建或查询车辆信息

**ParkingRecord（停车记录）**
- **字段**:
  - `vehicle`: 车辆（外键）
  - `parking_space`: 停车位（外键）
  - `entry_time`: 入场时间
  - `exit_time`: 出场时间
  - `duration_minutes`: 停车时长（分钟）
  - `fee`: 停车费用
  - `is_paid`: 是否已支付
  - `is_free_parking`: 是否免费停车
  - `discount_rate`: 折扣率
  - `operator`: 操作员
  - `plate_province_code`: 车牌省份代码
  - `plate_city_code`: 车牌地级市代码
- **方法**:
  - `calculate_fee()`: 计算停车费用（支持固定和阶梯收费）
- **使用场景**: 记录每次停车，计算费用

**VIPVehicle（VIP车辆）**
- **字段**:
  - `license_plate`: 车牌号
  - `vip_type`: VIP类型（员工、VIP客户）
  - `is_free`: 是否免费
  - `discount_rate`: 折扣率
  - `is_active`: 是否有效
- **使用场景**: 管理员工和VIP客户的免费/折扣停车

#### 2. 业务服务层 (services.py)

**ParkingLotService（停车场服务）**
- `get_active_lots()`: 获取所有活跃停车场（带车位统计）
- `get_active_lots_with_availability()`: 获取停车场及可用车位信息
- `get_lot_by_id()`: 根据ID获取停车场（带缓存）

**ParkingSpaceService（停车位服务）**
- `get_available_space()`: 获取可用车位
- `get_space_statistics()`: 获取车位统计信息

**VehicleService（车辆服务）**
- `get_or_create_vehicle()`: 获取或创建车辆记录
- `get_vehicle_by_plate()`: 根据车牌号获取车辆
- `is_vehicle_parked()`: 检查车辆是否在场

**ParkingRecordService（停车记录服务）**
- `vehicle_entry()`: 车辆入场（完整流程，包含并发控制）
- `vehicle_exit()`: 车辆出场（完整流程，包含费用计算）
- `query_vehicle_status()`: 查询车辆停车状态
- `search_records()`: 搜索停车记录（支持多条件筛选）
- `get_active_records()`: 获取所有在场车辆记录
- `get_today_statistics()`: 获取今日统计数据
- `get_recent_records()`: 获取最近的停车记录

**DashboardService（仪表盘服务）**
- `get_dashboard_data()`: 获取仪表盘所需的所有数据

#### 3. 视图层

**工作人员视图** (views.py)
- `login_view()`: 登录页面
- `logout_view()`: 登出
- `dashboard_view()`: 工作台

**管理后台视图** (admin_views.py)
- 停车场管理（列表、详情、编辑、删除）
- 车位管理（列表、编辑、删除、批量创建）
- 车辆管理（列表、编辑）
- 停车记录管理（列表、详情、筛选）

**API视图** (api_views.py)
- `api_vehicle_entry()`: 车辆入场API
- `api_vehicle_exit()`: 车辆出场API
- `api_vehicle_query()`: 车辆查询API
- `api_validate_plate()`: 车牌号验证API
- `api_dashboard_stats()`: 仪表盘统计API
- `api_available_spaces()`: 可用车位查询API

**客户端视图** (customer_views.py)
- `customer_index()`: 客户自助查询页面

**认证视图** (auth_views.py)
- `register_view()`: 用户注册
- `send_verification_code()`: 发送验证码
- `forgot_password_view()`: 忘记密码
- `reset_password_view()`: 重置密码

**费率管理视图** (pricing_views.py)
- `pricing_template_list()`: 费率模板列表
- `pricing_template_edit()`: 费率模板编辑
- `pricing_config_edit()`: 停车场费率配置
- `pricing_preview()`: 费率预览API

**其他功能视图**:
- `contact_views.py`: 联系功能
- `schedule_views.py`: 排班管理
- `police_views.py`: 公安查询
- `alert_views.py`: 通缉警报

#### 4. 表单验证 (forms.py)

- `VehicleEntryForm`: 车辆入场表单验证
- `VehicleExitForm`: 车辆出场表单验证
- `VehicleQueryForm`: 车辆查询表单验证
- `RegisterForm`: 用户注册表单验证
- `ForgotPasswordForm`: 忘记密码表单验证
- `ResetPasswordForm`: 重置密码表单验证

---

## 扩展模块功能

### apps.common - 通用模块

**功能**:
- 提供通用模型基类（时间戳、软删除）
- 工具函数（货币格式化、时长格式化等）
- 装饰器（性能计时、缓存、异常处理）
- 自定义异常类
- 自定义验证器

**使用场景**: 所有模块共享的基础功能

---

### apps.infrastructure - 基础设施模块

**功能**:
- **中间件**:
  - `RequestLoggingMiddleware`: 请求日志记录
  - `PerformanceMonitoringMiddleware`: 性能监控（慢请求检测）
- **信号处理**:
  - `log_model_save()`: 记录模型保存操作
  - `log_model_delete()`: 记录模型删除操作
- **日志配置**: loguru日志系统初始化

**使用场景**: 系统级功能，自动运行

---

### apps.audit - 审计日志模块

**功能**:
- **模型**: `AuditLog` - 记录所有重要操作
- **服务**: `AuditService` - 提供日志记录服务
- **中间件**: `AuditLogMiddleware` - 自动记录登录/登出

**使用场景**: 管理员查看系统操作日志

---

### apps.config - 系统配置模块

**功能**:
- **模型**: `SystemConfig` - 系统配置存储
- **服务**: `ConfigService` - 配置的读取、设置和缓存

**使用场景**: 存储系统级配置参数

---

### apps.notifications - 通知系统模块

**功能**:
- 创建和管理通知
- 通知状态管理（未读/已读）

**使用场景**: 系统消息通知（待扩展）

---

### apps.reports - 报表统计模块

**功能**:
- 生成各类统计报表
- 数据分析和导出

**使用场景**: 管理员查看统计数据（待扩展）

---

## 不同角色的使用差异

### 界面差异

| 功能 | 管理员 | 工作人员 | 客户 |
|------|--------|----------|------|
| 登录页面 | ✅ | ✅ | ❌ |
| 工作台 | ✅ | ✅ | ❌ |
| 管理后台 | ✅ | ❌ | ❌ |
| 客户自助页面 | ✅ | ✅ | ✅ |
| 车辆入场 | ✅ | ✅ | ❌ |
| 车辆出场 | ✅ | ✅ | ❌ |
| 车辆查询 | ✅ | ✅ | ✅（仅自己） |
| 停车场管理 | ✅ | ❌ | ❌ |
| 车位管理 | ✅ | ❌ | ❌ |
| 费率配置 | ✅ | ❌ | ❌ |
| 通缉警报 | ✅ | ❌ | ❌ |
| 排班管理 | ✅ | ❌ | ❌ |

### 数据访问差异

| 数据 | 管理员 | 工作人员 | 客户 |
|------|--------|----------|------|
| 所有停车记录 | ✅ | ❌ | ❌ |
| 今日统计 | ✅ | ✅ | ❌ |
| 实时车位状态 | ✅ | ✅ | ✅ |
| 停车场配置 | ✅ | ❌ | ❌ |
| 费率配置 | ✅ | ❌ | ❌ |
| 自己的停车记录 | ✅ | ✅ | ✅ |
| 其他车辆信息 | ✅ | ✅ | ❌ |

### 操作权限差异

| 操作 | 管理员 | 工作人员 | 客户 |
|------|--------|----------|------|
| 创建停车场 | ✅ | ❌ | ❌ |
| 编辑停车场 | ✅ | ❌ | ❌ |
| 删除停车场 | ✅ | ❌ | ❌ |
| 批量创建车位 | ✅ | ❌ | ❌ |
| 配置费率 | ✅ | ❌ | ❌ |
| 车辆入场 | ✅ | ✅ | ❌ |
| 车辆出场 | ✅ | ✅ | ❌ |
| 查询车辆 | ✅ | ✅ | ✅（仅自己） |
| 管理VIP车辆 | ✅ | ❌ | ❌ |
| 查看审计日志 | ✅ | ❌ | ❌ |

---

## 功能使用指南

### 管理员使用指南

#### 1. 系统初始化

**创建停车场**:
1. 登录系统（`/login/`）
2. 进入管理后台（`/manage/`）
3. 点击"停车场管理" > "新增停车场"
4. 填写信息：
   - 停车场名称
   - 地址
   - 停车场类型（露天/立体/街道/地下）
   - 楼层列表（如：B2, B1, 1F, 2F）
   - 区域列表（按楼层组织，如：1F-A区, 1F-B区）
   - 小时费率
5. 保存后系统自动创建

**批量创建车位**:
1. 进入"车位管理" > "批量创建"
2. 选择创建方式：
   - **简单创建**: 输入前缀和数量（如：A001-A100）
   - **范围创建**: 输入起始和结束车位号（如：A001-A500）
   - **文件上传**: 上传Excel/TXT/MD文件
3. 系统自动解析并创建车位
4. 查看创建结果详情

**配置费率**:
1. 进入"费率管理" > "费率模板"
2. 创建费率模板：
   - 选择收费类型（固定/阶梯）
   - 设置免费时长
   - 设置每日上限
   - 配置阶梯规则（如使用阶梯收费）
3. 应用到停车场：
   - 进入"停车场管理" > 选择停车场 > "费率配置"
   - 选择模板或自定义规则
   - 使用预览功能测试费率计算

#### 2. 日常管理

**查看统计数据**:
- 管理后台首页显示系统整体统计
- 工作台显示实时数据

**管理用户**:
- 通过Django Admin管理用户账号
- 分配用户角色（管理员/工作人员/客户）

**查看审计日志**:
- 进入审计日志模块查看所有操作记录

---

### 工作人员使用指南

#### 1. 登录系统

1. 访问 `/login/`
2. 输入用户名和密码
3. 点击"登录"按钮
4. 自动跳转到工作台

#### 2. 车辆入场操作

**方式一：快捷入场（推荐）**
1. 在工作台点击"车辆入场"按钮（导航栏或快捷操作区）
2. 使用智能车牌输入组件输入车牌号：
   - 选择省份简称（如：粤）
   - 选择地级市代号（如：E）
   - 输入序号（5位普通车牌或6位新能源车牌）
3. 选择停车场
4. 系统自动加载可用停车位，选择停车位（必选）
5. 选择车辆类型（可选，默认：轿车）
6. 点击"确认入场"
7. 系统显示成功提示

**方式二：通过工作台快捷操作**
1. 在工作台快捷操作区点击"车辆入场"图标
2. 后续步骤同上

**注意事项**:
- 车牌号必须符合GA 36-2018标准
- 必须选择停车位
- 如果车辆已在场内，系统会提示

#### 3. 车辆出场操作

**方式一：快捷出场（推荐）**
1. 点击"车辆出场"按钮
2. 输入车牌号
3. 点击搜索按钮或按回车
4. 系统显示：
   - 车牌号
   - 停车场和车位号
   - 入场时间
   - 停车时长
   - 应付费用
5. 确认信息无误后点击"确认结算"
6. 系统自动计算费用并完成出场

**注意事项**:
- 如果车辆不在场内，系统会提示
- 费用自动计算（考虑免费时长、阶梯收费、VIP折扣等）

#### 4. 车辆查询

1. 点击"查询车辆"按钮
2. 输入车牌号
3. 系统显示：
   - 车辆是否在场
   - 如果在场：停车场、车位、入场时间、当前费用
   - 如果不在场：上次离场时间、上次停车位置

---

### 客户使用指南

#### 1. 访问系统

1. 访问 `/parking/customer/`
2. 无需登录即可使用基础查询功能

#### 2. 查询停车状态

1. 在查询框输入车牌号
2. 点击"查询停车状态"按钮
3. 系统显示：
   - 车辆是否在场
   - 如果在场：
     - 停车场名称
     - 车位号
     - 入场时间
     - 停车时长
     - 当前费用（如果是VIP/员工，显示免费）
   - 如果不在场：
     - 上次离场时间
     - 上次停车位置

#### 3. 查看停车场状态

- 页面自动显示：
  - 空闲车位数
  - 已停车辆数
  - 总车位数
  - 停车费率

#### 4. 联系工作人员

1. 点击"联系我们"按钮（页面右下角浮动按钮）
2. 填写联系表单：
   - 姓名
   - 邮箱
   - 电话
   - 主题
   - 内容
3. 提交后系统自动发送邮件通知管理员

---

## 技术特性

### 性能优化

- **数据库查询优化**: 使用 `select_related` 和 `prefetch_related` 避免N+1查询
- **缓存机制**: 使用Django缓存框架缓存频繁查询的数据
- **并发控制**: 使用 `select_for_update` 防止并发冲突
- **事务管理**: 关键操作使用 `@transaction.atomic` 保证数据一致性

### 安全特性

- **CSRF保护**: 所有POST请求都有CSRF token验证
- **权限控制**: 使用装饰器 `@login_required` 和 `@staff_member_required`
- **输入验证**: 前后端双重验证
- **频率限制**: 验证码和联系表单有频率限制
- **Session管理**: 2小时过期，关闭浏览器时过期

### 用户体验

- **响应式设计**: 支持移动端、平板、桌面端
- **主题系统**: 11种主题色，支持亮暗模式切换
- **交互反馈**: 所有可点击元素都有悬停和点击反馈
- **实时更新**: 数据实时刷新，无需手动刷新页面
- **智能输入**: 车牌号输入组件，自动验证和格式化

---

**文档版本**: v1.1.0  
**最后更新**: 2025-12-12
